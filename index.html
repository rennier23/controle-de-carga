<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Dashboard Superfrio</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f4f6f9;
      margin: 0;
      padding: 0;
    }
    header {
      background: #1e3a8a;
      color: white;
      text-align: center;
      padding: 1rem;
    }
    .container {
      padding: 1.5rem;
      max-width: 1200px;
      margin: auto;
    }
    .cards {
      display: grid;
      grid-template-columns: repeat(auto-fit,minmax(200px,1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }
    .card {
      border-radius: 10px;
      padding: 1rem;
      color: white;
      font-weight: bold;
      text-align: center;
    }
    .azul { background: #3b82f6; }
    .verde { background: #10b981; }
    .amarelo { background: #f59e0b; }
    .vermelho { background: #ef4444; }
    .chart-container {
      position: relative;
      height: 350px;
      background: white;
      border-radius: 10px;
      padding: 1rem;
      margin-bottom: 2rem;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 10px;
      overflow: hidden;
    }
    th, td {
      padding: 0.7rem;
      border-bottom: 1px solid #ddd;
      text-align: center;
    }
    th {
      background: #1e40af;
      color: white;
    }
    .fotos {
      margin-bottom: 2rem;
    }
    .foto-card {
      display: inline-block;
      margin: 0.5rem;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 0.5rem;
      background: #fff;
      width: 120px;
      text-align: center;
    }
    .foto-card img {
      max-width: 100%;
      border-radius: 6px;
    }
  </style>
</head>
<body>
  <header>
    <h1>ðŸ“Š Dashboard Superfrio</h1>
  </header>
  <div class="container">
    <!-- Cards -->
    <div class="cards">
      <div class="card azul">Paletes enviados: <span id="env">0</span></div>
      <div class="card verde">Paletes recebidos: <span id="rec">0</span></div>
      <div class="card amarelo">Quebrados: <span id="qbr">0</span></div>
      <div class="card vermelho">Total de viagens: <span id="via">0</span></div>
    </div>

    <!-- GrÃ¡fico -->
    <div class="chart-container">
      <canvas id="dashChart"></canvas>
    </div>

    <!-- Fotos -->
    <div class="fotos">
      <h2>Fotos</h2>
      <input type="file" id="fotoInput" accept="image/*" capture="environment">
      <div id="fotoLista"></div>
    </div>

    <!-- Tabela -->
    <h2>Carregamento</h2>
    <table>
      <thead>
        <tr>
          <th>Data</th>
          <th>Placa</th>
          <th>Motorista</th>
          <th>Paletes enviados</th>
          <th>Paletes recebidos</th>
          <th>Conferente 1</th>
          <th>Conferente 2</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody id="tabelaDados"></tbody>
    </table>
  </div>

<script>
  // --- Supabase Config ---
  const SUPABASE_URL = "https://SEU-PROJETO.supabase.co";
  const SUPABASE_KEY = "SEU-API-KEY";
  const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
  const bucketName = "fotos"; // precisa existir no Supabase

  // --- SimulaÃ§Ã£o de dados ---
  const docs = [
    {data:"2025-08-01", placa:"ABC-1234", motorista:"JoÃ£o", enviados:120, recebidos:118, conf1:"Carlos", conf2:"Ana", status:"OK"},
    {data:"2025-08-02", placa:"DEF-5678", motorista:"Pedro", enviados:100, recebidos:95, conf1:"Marcos", conf2:"Rita", status:"Quebra"},
    {data:"2025-08-03", placa:"GHI-9012", motorista:"Lucas", enviados:140, recebidos:140, conf1:"Paulo", conf2:"Sara", status:"OK"}
  ];

  let dashChart;

  function loadDashboard(){
    // Totais
    const enviados = docs.reduce((a,b)=>a+b.enviados,0);
    const recebidos = docs.reduce((a,b)=>a+b.recebidos,0);
    const quebrados = enviados-recebidos;
    const viagens = docs.length;
    document.getElementById("env").innerText = enviados;
    document.getElementById("rec").innerText = recebidos;
    document.getElementById("qbr").innerText = quebrados;
    document.getElementById("via").innerText = viagens;

    // Tabela
    const tb = document.getElementById("tabelaDados");
    tb.innerHTML="";
    docs.forEach(d=>{
      tb.innerHTML += `<tr>
        <td>${d.data}</td><td>${d.placa}</td><td>${d.motorista}</td>
        <td>${d.enviados}</td><td>${d.recebidos}</td>
        <td>${d.conf1}</td><td>${d.conf2}</td><td>${d.status}</td>
      </tr>`;
    });

    // GrÃ¡fico de linhas suave/monotone
    const dias = docs.map(d=>d.data);
    const serieEnv = docs.map(d=>d.enviados);
    const serieRec = docs.map(d=>d.recebidos);
    const serieQbr = docs.map(d=>d.enviados-d.recebidos);

    const ctx = document.getElementById("dashChart").getContext("2d");
    if(dashChart) dashChart.destroy();
    dashChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: dias,
        datasets: [
          { label:"Enviados", data:serieEnv, borderColor:"#3b82f6",
            backgroundColor:"rgba(59,130,246,0.08)", tension:0.4, cubicInterpolationMode:'monotone' },
          { label:"Recebidos", data:serieRec, borderColor:"#10b981",
            backgroundColor:"rgba(16,185,129,0.08)", tension:0.4, cubicInterpolationMode:'monotone' },
          { label:"Quebra", data:serieQbr, borderColor:"#f59e0b",
            backgroundColor:"rgba(245,158,11,0.08)", tension:0.4, cubicInterpolationMode:'monotone' }
        ]
      },
      options:{
        responsive:true,
        maintainAspectRatio:false,
        plugins:{ legend:{position:'top'} },
        interaction:{mode:'index',intersect:false},
        scales:{
          y:{beginAtZero:true,grid:{color:'rgba(0,0,0,0.06)'}},
          x:{grid:{display:false}}
        }
      }
    });
  }

  // --- Upload de fotos ---
  document.getElementById("fotoInput").addEventListener("change", async (e)=>{
    const file = e.target.files[0];
    if(!file) return;

    const filePath = `${Date.now()}_${file.name}`;
    let { data, error } = await supabaseClient.storage.from(bucketName).upload(filePath, file);
    if(error){ alert("Erro ao enviar: "+error.message); return; }

    const { data:publicURL } = supabaseClient.storage.from(bucketName).getPublicUrl(filePath);
    renderFoto(publicURL.publicUrl, filePath);
  });

  function renderFoto(url, filePath){
    const div = document.createElement("div");
    div.className="foto-card";
    div.innerHTML = `
      <img src="${url}" alt="foto">
      <button onclick="abrirFoto('${url}')">abrir</button>
      <button onclick="excluirFoto('${filePath}', this)">Excluir</button>
    `;
    document.getElementById("fotoLista").appendChild(div);
  }

  function abrirFoto(url){ window.open(url, "_blank"); }

  async function excluirFoto(filePath, btn){
    await supabaseClient.storage.from(bucketName).remove([filePath]);
    btn.parentElement.remove();
  }

  // init
  loadDashboard();
</script>
</body>
</html>
