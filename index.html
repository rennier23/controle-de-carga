<!DOCTYPE html>
<html lang="pt-br">
<head>
  <!-- Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://humurozsimozypajncsv.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh1bXVyb3pzaW1venlwYWpuY3N2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUyODE3NzUsImV4cCI6MjA3MDg1Nzc3NX0.uAvgWY1HMvrSGNLaYjaFUQEh5wC8YlfNTRV5J79HVEQ";
    window.supa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  </script>

  <!-- Chart.js (para o gráfico de linha do dashboard) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>

  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SuperFrio – Controle de Carga</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" integrity="sha512-Fo3rlrZj/k7ujTnHg4CGR2D7kSs0v4LLanw2qksYuRlEzO+tcaEPQogQ0KaoGN26/zrn20ImR1DfuLWnOo7aBA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <style>
    :root{
      --bg: #F8FAFC;
      --card: #FFFFFF;
      --text: #334155;
      --muted: #64748B;
      --border: #E2E8F0;
      --primary: #148CD6;
      --primary-dark: #0A6FB9;
      --primary-light: #E0F2FE;
      --danger: #DC2626;
      --ring: rgba(20,140,214,.2);
      --ok: #16A34A;
      --ok-100: #DCFCE7;
      --ok-300: #86EFAC;
      --info: #0EA5E9;
      --info-100: #E0F2FE;
      --info-300: #7DD3FC;
      --warn: #F59E0B;
      --warn-100: #FEF3C7;
      --warn-300: #FCD34D;
      --err: #EF4444;
      --err-100: #FEE2E2;
      --err-300: #FCA5A5;
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: system-ui, 'Inter', 'Roboto', 'Open Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      line-height: 1.6;
      font-size: 14px;
    }

    .wrap {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    /* Header modernizado */
    .brandbar {
      background: var(--primary);
      padding: 20px 24px;
      color: #fff;
      box-shadow: var(--shadow-lg);
      border-radius: 0 0 16px 16px;
    }

    .brandbar .row {
      display: flex;
      align-items: center;
      gap: 20px;
      flex-wrap: wrap;
      justify-content: space-between;
      max-width: 1200px;
      margin: 0 auto;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .logo img {
      height: 42px;
      width: auto;
      display: block;
      border-radius: 8px;
      box-shadow: var(--shadow-md);
    }

    .logo h1 {
      margin: 0;
      font-size: 22px;
      font-weight: 700;
      letter-spacing: -0.025em;
    }

    .tagline {
      margin: 0;
      font-size: 13px;
      opacity: 0.9;
      font-weight: 400;
    }

    /* Navegação modernizada */
    nav {
      display: flex;
      gap: 4px;
      background: rgba(255, 255, 255, 0.1);
      padding: 4px;
      border-radius: 12px;
      backdrop-filter: blur(10px);
    }

    nav button {
      border: none;
      background: transparent;
      color: rgba(255, 255, 255, 0.8);
      padding: 10px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
      font-size: 14px;
      transition: all 0.2s ease;
      position: relative;
    }

    nav button:hover {
      background: rgba(255, 255, 255, 0.15);
      color: #fff;
    }

    nav button.active {
      background: #fff;
      color: var(--primary);
      box-shadow: var(--shadow-sm);
    }

    /* Cards modernizados */
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      box-shadow: var(--shadow-sm);
      transition: box-shadow 0.2s ease;
    }

    .card:hover {
      box-shadow: var(--shadow-md);
    }

    /* Formulários modernizados */
    label {
      display: block;
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 8px;
      color: var(--text);
    }

    input, textarea, select {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid var(--border);
      border-radius: 12px;
      font-size: 14px;
      background: #fff;
      outline: none;
      transition: all 0.2s ease;
      font-family: inherit;
    }

    input:focus, textarea:focus, select:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px var(--ring);
    }

    input:hover, textarea:hover, select:hover {
      border-color: var(--primary-light);
    }

    textarea {
      min-height: 100px;
      resize: vertical;
    }

    /* Grid system */
    .grid {
      display: grid;
      gap: 16px;
    }

    .g2 {
      grid-template-columns: repeat(2, 1fr);
    }

    .g3 {
      grid-template-columns: repeat(3, 1fr);
    }

    /* Botões modernizados */
    .actions {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .btn {
      background: var(--primary);
      color: #fff;
      border: none;
      border-radius: 12px;
      padding: 12px 20px;
      cursor: pointer;
      font-weight: 500;
      font-size: 14px;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      box-shadow: var(--shadow-sm);
    }

    .btn:hover {
      background: var(--primary-dark);
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn.ghost {
      background: transparent;
      color: var(--primary);
      border: 1px solid var(--primary);
      box-shadow: none;
    }

    .btn.ghost:hover {
      background: var(--primary-light);
      transform: translateY(-1px);
      box-shadow: var(--shadow-sm);
    }

    .btn.danger {
      background: var(--danger);
    }

    .btn.danger:hover {
      background: #B91C1C;
    }

    /* Pills modernizadas */
    .pill {
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 8px 16px;
      font-size: 13px;
      color: var(--text);
      background: var(--card);
      font-weight: 500;
      box-shadow: var(--shadow-sm);
    }

    /* Tabelas modernizadas */
    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
      box-shadow: var(--shadow-sm);
    }

    th, td {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      background: #fff;
      text-align: left;
      font-size: 14px;
    }

    th {
      background: #F8FAFC;
      color: var(--text);
      font-weight: 600;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    tr:last-child td {
      border-bottom: none;
    }

    tr:hover td {
      background: #F8FAFC;
    }

    .table-wrap {
      overflow: auto;
      border-radius: 12px;
    }

    /* Utilitários */
    .muted {
      color: var(--muted);
      font-size: 13px;
    }

    .row {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }

    .hide {
      display: none !important;
    }

    /* KPI Cards modernizados */
    .kpis {
      display: grid;
      gap: 16px;
      grid-template-columns: repeat(3, 1fr);
    }

    .kpi {
      border-radius: 16px;
      padding: 24px;
      border: 1px solid var(--border);
      background: #fff;
      box-shadow: var(--shadow-md);
      transition: all 0.2s ease;
      position: relative;
      overflow: hidden;
    }

    .kpi:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .kpi--blue {
      background: linear-gradient(135deg, var(--info-100) 0%, #fff 100%);
      border-color: var(--info-300);
    }

    .kpi--green {
      background: linear-gradient(135deg, var(--ok-100) 0%, #fff 100%);
      border-color: var(--ok-300);
    }

    .kpi--red {
      background: linear-gradient(135deg, var(--err-100) 0%, #fff 100%);
      border-color: var(--err-300);
    }

    .kpi .title {
      color: var(--muted);
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 12px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .kpi .value {
      font-size: 32px;
      font-weight: 800;
      line-height: 1;
    }

    /* Fotos modernizadas */
    .photo-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 16px;
    }

    .thumb {
      position: relative;
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
      background: #fff;
      box-shadow: var(--shadow-sm);
      transition: all 0.2s ease;
    }

    .thumb:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .thumb img {
      display: block;
      width: 100%;
      height: 100%;
      object-fit: cover;
      aspect-ratio: 1/1;
    }

    .thumb button {
      position: absolute;
      top: 8px;
      right: 8px;
      background: rgba(255, 255, 255, 0.9);
      color: var(--danger);
      border: none;
      border-radius: 8px;
      padding: 6px 8px;
      font-size: 12px;
      cursor: pointer;
      backdrop-filter: blur(10px);
      transition: all 0.2s ease;
    }

    .thumb button:hover {
      background: var(--danger);
      color: #fff;
    }

    .thumb a {
      position: absolute;
      left: 8px;
      bottom: 8px;
      background: rgba(255, 255, 255, 0.9);
      border: none;
      border-radius: 8px;
      padding: 4px 8px;
      font-size: 11px;
      text-decoration: none;
      color: var(--primary);
      backdrop-filter: blur(10px);
      transition: all 0.2s ease;
    }

    .thumb a:hover {
      background: var(--primary);
      color: #fff;
    }

    /* Títulos modernizados */
    h3 {
      font-size: 18px;
      font-weight: 600;
      margin: 24px 0 16px 0;
      color: var(--text);
      letter-spacing: -0.025em;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    h3 i {
      color: var(--primary);
      font-size: 20px;
    }

    h4 {
      font-size: 16px;
      font-weight: 600;
      margin: 16px 0 12px 0;
      color: var(--text);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    h4 i {
      color: var(--primary);
      font-size: 18px;
    }

    /* Responsividade */
    @media (max-width: 860px) {
      .wrap {
        padding: 16px;
        gap: 16px;
      }

      .brandbar {
        padding: 16px;
        border-radius: 0;
      }

      .brandbar .row {
        flex-direction: column;
        gap: 16px;
        align-items: flex-start;
      }

      nav {
        width: 100%;
        justify-content: center;
      }

      .g3, .g2 {
        grid-template-columns: 1fr;
      }

      .kpis {
        grid-template-columns: 1fr;
      }

      .actions {
        width: 100%;
        justify-content: stretch;
      }

      .btn {
        flex: 1;
        justify-content: center;
      }
    }

    @media print {
      .brandbar, nav, .actions, .muted, .hide-on-print {
        display: none !important;
      }
      
      .wrap {
        gap: 12px;
        padding: 0 16px;
      }
      
      .card {
        box-shadow: none;
        border: 1px solid #ddd;
      }
    }

    /* Animações sutis */
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .card {
      animation: fadeIn 0.3s ease;
    }

    /* Estados de loading */
    .loading {
      opacity: 0.6;
      pointer-events: none;
    }

    .loading::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 20px;
      height: 20px;
      margin: -10px 0 0 -10px;
      border: 2px solid var(--primary);
      border-radius: 50%;
      border-top-color: transparent;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }
  </style>
</head>
<body>
  <div class="brandbar">
    <div class="row">
      <div class="logo">
        <img src="https://dummyimage.com/140x38/148cd6/ffffff&text=SuperFrio" alt="SuperFrio logo"/>
        <div>
          <h1>SuperFrio – Controle de Carga</h1>
          <p class="tagline">Logística Frigorificada • Carregamento & Descarregamento</p>
        </div>
      </div>
      <nav>
        <button id="tab-novo" class="active">Novo</button>
        <button id="tab-editar">Editar</button>
        <button id="tab-pesquisar">Pesquisar</button>
        <button id="tab-dash">Dashboard</button>
      </nav>
    </div>
  </div>

  <div class="wrap">
    <!-- NOVO -->
    <section id="page-novo" class="card">
      <div class="row" style="justify-content:space-between">
        <div class="pill">Documento: <b id="novo-doc"></b> • Status: <b id="novo-status"></b></div>
        <div class="actions">
          <button class="btn" id="novo-salvar">Salvar</button>
          <button class="btn ghost" id="novo-novo">Novo Doc</button>
          <button class="btn ghost" id="novo-imprimir">Imprimir / PDF</button>
        </div>
      </div>

      <h3><i class="fas fa-id-card"></i> Identificação</h3>
      <div class="grid g3">
        <div><label>Nº Documento (auto)</label><input id="novo-numdoc" readonly></div>
        <div><label>Data carregamento</label><input type="date" id="novo-data"/></div>
        <div>
          <label>Status</label>
          <select id="novo-status-select">
            <option>Em trânsito</option>
            <option>Carregando</option>
            <option>Recebido</option>
          </select>
        </div>
        <div><label>Unidade Origem</label><input id="novo-origem" value="RJ"/></div>
        <div><label>Unidade Destino</label><input id="novo-destino"/></div>
        <div><label>Placa</label><input id="novo-placa" placeholder="Ex.: ABC1D23"/></div>
        <div><label>Motorista</label><input id="novo-motorista"/></div>
        <div><label>Conferente (carregamento)</label><input id="novo-conf-origem"/></div>
        <div class="g2" style="grid-column:1/-1"><label>Observações</label><input id="novo-obs"/></div>
      </div>

      <!-- Fotos (NOVO) -->
      <h3 style="margin-top:12px"><i class="fas fa-camera"></i> Fotos</h3>
      <div class="actions">
        <input id="novo-file" type="file" accept="image/*" capture="environment" multiple class="hide"/>
        <button class="btn" id="novo-add-foto">Adicionar foto</button>
        <span class="muted">No celular, abre a câmera.</span>
      </div>
      <div id="novo-fotos" class="photo-grid" style="margin-top:8px"></div>

      <h3 style="margin-top:12px"><i class="fas fa-truck-loading"></i> Carregamento</h3>
      <table id="novo-carreg">
        <thead><tr><th>Descrição</th><th>Qtd (pallets)</th><th>Observações</th><th class="hide-on-print"></th></tr></thead>
        <tbody></tbody>
      </table>
      <div class="row" style="justify-content:space-between;margin-top:8px">
        <button class="btn ghost" id="novo-add-item">+ Adicionar item</button>
        <div class="pill">Total carregado: <b id="novo-total-carreg">0</b></div>
      </div>

      <h3 style="margin-top:12px"><i class="fas fa-truck-ramp-box"></i> Descarregamento</h3>
      <table id="novo-desc">
        <thead><tr><th>Descrição</th><th>Qtd Recebida</th><th>Diferença</th><th>Observações</th></tr></thead>
        <tbody></tbody>
      </table>
      <div class="grid g2" style="margin-top:8px">
        <div><label>Conferente (descarregamento)</label><input id="novo-conf-destino"/></div>
        <div class="row" style="justify-content:flex-end"><div class="pill">Total recebido: <b id="novo-total-receb">0</b> • Diferença total: <b id="novo-total-diff">0</b></div></div>
      </div>
    </section>

    <!-- EDITAR -->
    <section id="page-editar" class="card hide">
      <div class="row">
        <input id="editar-id" placeholder="Digite nº do documento…"/>
        <button class="btn" id="editar-abrir">Abrir</button>
        <button class="btn danger" id="editar-remover">Excluir</button>
      </div>

      <div id="editar-form" class="hide">
        <div class="row" style="justify-content:space-between;margin-top:8px">
          <div class="pill">Documento: <b id="editar-doc"></b> • Status: <b id="editar-status"></b></div>
          <div class="actions">
            <button class="btn" id="editar-salvar">Salvar</button>
            <button class="btn ghost" id="editar-imprimir">Imprimir / PDF</button>
          </div>
        </div>

        <h3><i class="fas fa-id-card"></i> Identificação</h3>
        <div class="grid g3">
          <div><label>Nº Documento</label><input id="ed-numdoc" readonly></div>
          <div><label>Data carregamento</label><input type="date" id="ed-data"/></div>
          <div>
            <label>Status</label>
            <select id="ed-status">
              <option>Em trânsito</option>
              <option>Carregando</option>
              <option>Recebido</option>
            </select>
          </div>
          <div><label>Unidade Origem</label><input id="ed-origem"/></div>
          <div><label>Unidade Destino</label><input id="ed-destino"/></div>
          <div><label>Placa</label><input id="ed-placa"/></div>
          <div><label>Motorista</label><input id="ed-motorista"/></div>
          <div><label>Conferente (carregamento)</label><input id="ed-conf-origem"/></div>
          <div class="g2" style="grid-column:1/-1"><label>Observações</label><input id="ed-obs"/></div>
        </div>

        <!-- Fotos (EDITAR) -->
        <h3 style="margin-top:12px"><i class="fas fa-camera"></i> Fotos</h3>
        <div class="actions">
          <input id="ed-file" type="file" accept="image/*" capture="environment" multiple class="hide"/>
          <button class="btn" id="ed-add-foto">Adicionar foto</button>
        </div>
        <div id="ed-fotos" class="photo-grid" style="margin-top:8px"></div>

        <h3 style="margin-top:12px"><i class="fas fa-truck-loading"></i> Carregamento</h3>
        <table id="ed-carreg">
          <thead><tr><th>Descrição</th><th>Qtd (pallets)</th><th>Observações</th><th class="hide-on-print"></th></tr></thead>
          <tbody></tbody>
        </table>
        <div class="row" style="justify-content:space-between;margin-top:8px">
          <button class="btn ghost" id="ed-add-item">+ Adicionar item</button>
          <div class="pill">Total carregado: <b id="ed-total-carreg">0</b></div>
        </div>

        <h3 style="margin-top:12px"><i class="fas fa-truck-ramp-box"></i> Descarregamento</h3>
        <table id="ed-desc">
          <thead><tr><th>Descrição</th><th>Qtd Recebida</th><th>Diferença</th><th>Observações</th></tr></thead>
          <tbody></tbody>
        </table>
        <div class="grid g2" style="margin-top:8px">
          <div><label>Conferente (descarregamento)</label><input id="ed-conf-destino"/></div>
          <div class="row" style="justify-content:flex-end"><div class="pill">Total recebido: <b id="ed-total-receb">0</b> • Diferença total: <b id="ed-total-diff">0</b></div></div>
        </div>
      </div>
    </section>

    <!-- PESQUISAR -->
    <section id="page-pesquisar" class="card hide">
      <div class="grid g3">
        <div><label>Nº Documento</label><input id="q-doc"/></div>
        <div><label>Placa</label><input id="q-placa"/></div>
        <div><label>Motorista</label><input id="q-motorista"/></div>
      </div>
      <div class="actions" style="margin-top:8px">
        <button class="btn" id="q-buscar">Pesquisar</button>
        <button class="btn ghost" id="q-limpar">Limpar</button>
      </div>
      <div style="margin-top:10px">
        <table id="q-table">
          <thead><tr><th>Documento</th><th>Data</th><th>Placa</th><th>Motorista</th><th>Status</th><th>Ações</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- DASHBOARD -->
    <section id="page-dash" class="card hide">
      <div class="row" style="justify-content:space-between">
        <h3 style="margin:0"><i class="fas fa-chart-line"></i> Dashboard</h3>
        <div class="row">
          <div>
            <label>De</label>
            <input type="date" id="dash-de">
          </div>
          <div>
            <label>Até</label>
            <input type="date" id="dash-ate">
          </div>
          <button class="btn" id="dash-atualizar" style="align-self:flex-end">Atualizar</button>
        </div>
      </div>

      <div class="kpis" style="margin-top:10px">
        <div class="kpi kpi--blue"><div class="title">Paletes enviados</div><div class="value" id="kpi-enviados">0</div></div>
        <div class="kpi kpi--green"><div class="title">Paletes recebidos</div><div class="value" id="kpi-recebidos">0</div></div>
        <div class="kpi kpi--red"><div class="title">Quebra</div><div class="value" id="kpi-quebra">0</div></div>
      </div>

      <div class="card" style="margin-top:10px"><canvas id="dash-chart" height="120"></canvas></div>

      <div class="card" style="margin-top:10px">
        <h4 style="margin:0 0 8px 0"><i class="fas fa-table"></i> Detalhes por documento</h4>
        <div class="table-wrap">
          <table id="dash-table">
            <thead>
              <tr>
                <th>Data</th><th>Placa</th><th>Motorista</th>
                <th>Paletes enviados</th><th>Paletes recebidos</th>
                <th>Conferente 1</th><th>Conferente 2</th><th>Status</th>
              </tr>
            </thead><tbody></tbody>
          </table>
        </div>
      </div>
    </section>
  </div>

  <script>
    const $ = (id)=>document.getElementById(id);

    // Tabs
    const tabs={novo:{btn:$('tab-novo'),page:$('page-novo')},
                editar:{btn:$('tab-editar'),page:$('page-editar')},
                pesq:{btn:$('page-pesquisar')?$('tab-pesquisar'):null,page:$('page-pesquisar')},
                dash:{btn:$('tab-dash'),page:$('page-dash')}};
    function activate(t){
      Object.values(tabs).forEach(x=>{ if(!x) return; x.btn.classList.remove('active');x.page.classList.add('hide');});
      t.btn.classList.add('active'); t.page.classList.remove('hide');
    }
    Object.values(tabs).forEach(t=> t && t.btn.addEventListener('click', async ()=>{
      activate(t);
      if(t===tabs.novo) resetNovoForm();
      if(t===tabs.dash) await loadDashboard();
    }));

    // Util
    function genDocId(date = new Date()){
      const y=date.getFullYear(), m=date.getMonth()+1, d=date.getDate();
      const L='ABCDEFGHIJKLMNOPQRSTUVWXYZ';
      let a=L[Math.floor(Math.random()*26)], b=L[Math.floor(Math.random()*26)];
      while(a===b) b=L[Math.floor(Math.random()*26)];
      return `${y}${m}${d}${a}${b}`;
    }
    function ts(){ return new Date().toISOString().replace(/[:.]/g,'-'); }

    // Estado "novo"
    function newDocData(){
      return {id:genDocId(), status:'Em trânsito', data:new Date().toISOString().slice(0,10),
        origem:'RJ', destino:'', placa:'', motorista:'', confOrigem:'', obs:'', confDestino:'',
        fotos:[], carreg:[], desc:[]};
    }
    let novoDoc = newDocData();

    function resetNovoForm(){
      novoDoc = newDocData();
      $('novo-doc').textContent = novoDoc.id;
      $('novo-status').textContent = novoDoc.status;
      $('novo-numdoc').value = novoDoc.id;
      $('novo-data').value = novoDoc.data;
      $('novo-status-select').value = novoDoc.status;
      $('novo-origem').value = novoDoc.origem;
      $('novo-destino').value = novoDoc.destino;
      $('novo-placa').value = novoDoc.placa;
      $('novo-motorista').value = novoDoc.motorista;
      $('novo-conf-origem').value = novoDoc.confOrigem;
      $('novo-obs').value = novoDoc.obs;
      $('novo-conf-destino').value = novoDoc.confDestino;
      renderNovoFotos(); renderNovoCarreg(); renderNovoDesc();
    }

    function syncNovoForm(){
      novoDoc.status = $('novo-status-select').value;
      novoDoc.data = $('novo-data').value;
      novoDoc.origem = $('novo-origem').value;
      novoDoc.destino = $('novo-destino').value;
      novoDoc.placa = $('novo-placa').value;
      novoDoc.motorista = $('novo-motorista').value;
      novoDoc.confOrigem = $('novo-conf-origem').value;
      novoDoc.obs = $('novo-obs').value;
      novoDoc.confDestino = $('novo-conf-destino').value;
      $('novo-status').textContent = novoDoc.status;
    }

    // Fotos
    function renderNovoFotos(){
      const c = $('novo-fotos');
      c.innerHTML = novoDoc.fotos.map((f,i)=>`
        <div class="thumb">
          <img src="${f.url}" alt="Foto ${i+1}"/>
          <button onclick="removeNovoFoto(${i})">×</button>
          <a href="${f.url}" target="_blank">Ver</a>
        </div>
      `).join('');
    }
    function removeNovoFoto(i){ novoDoc.fotos.splice(i,1); renderNovoFotos(); }
    $('novo-add-foto').onclick = ()=> $('novo-file').click();
    $('novo-file').onchange = async (e)=>{
      for(let file of e.target.files){
        const {data,error} = await supa.storage.from('fotos').upload(`${ts()}-${file.name}`, file);
        if(error) { alert('Erro ao enviar foto: '+error.message); continue; }
        const {data:{publicUrl}} = supa.storage.from('fotos').getPublicUrl(data.path);
        novoDoc.fotos.push({url:publicUrl, path:data.path});
      }
      renderNovoFotos(); e.target.value='';
    };

    // Carregamento
    function renderNovoCarreg(){
      const tbody = $('novo-carreg').querySelector('tbody');
      tbody.innerHTML = novoDoc.carreg.map((item,i)=>`
        <tr>
          <td><input value="${item.desc}" onchange="novoDoc.carreg[${i}].desc=this.value"></td>
          <td><input type="number" value="${item.qtd}" onchange="novoDoc.carreg[${i}].qtd=+this.value; updateNovoTotals()"></td>
          <td><input value="${item.obs}" onchange="novoDoc.carreg[${i}].obs=this.value"></td>
          <td class="hide-on-print"><button class="btn danger" onclick="removeNovoCarreg(${i})">×</button></td>
        </tr>
      `).join('');
      updateNovoTotals();
    }
    function removeNovoCarreg(i){ novoDoc.carreg.splice(i,1); renderNovoCarreg(); }
    function addNovoCarreg(){ novoDoc.carreg.push({desc:'',qtd:0,obs:''}); renderNovoCarreg(); }
    $('novo-add-item').onclick = addNovoCarreg;

    // Descarregamento
    function renderNovoDesc(){
      const tbody = $('novo-desc').querySelector('tbody');
      tbody.innerHTML = novoDoc.carreg.map((item,i)=>{
        const descItem = novoDoc.desc[i] || {qtdReceb:0,obs:''};
        if(!novoDoc.desc[i]) novoDoc.desc[i] = descItem;
        const diff = descItem.qtdReceb - item.qtd;
        return `
          <tr>
            <td>${item.desc}</td>
            <td><input type="number" value="${descItem.qtdReceb}" onchange="novoDoc.desc[${i}].qtdReceb=+this.value; updateNovoTotals()"></td>
            <td style="color:${diff<0?'var(--danger)':diff>0?'var(--ok)':'inherit'}">${diff>0?'+':''}${diff}</td>
            <td><input value="${descItem.obs}" onchange="novoDoc.desc[${i}].obs=this.value"></td>
          </tr>
        `;
      }).join('');
      updateNovoTotals();
    }

    function updateNovoTotals(){
      const totalCarreg = novoDoc.carreg.reduce((s,x)=>s+x.qtd,0);
      const totalReceb = novoDoc.desc.reduce((s,x)=>s+(x.qtdReceb||0),0);
      const totalDiff = totalReceb - totalCarreg;
      $('novo-total-carreg').textContent = totalCarreg;
      $('novo-total-receb').textContent = totalReceb;
      $('novo-total-diff').textContent = (totalDiff>0?'+':'')+totalDiff;
      $('novo-total-diff').style.color = totalDiff<0?'var(--danger)':totalDiff>0?'var(--ok)':'inherit';
    }

    // Salvar
    $('novo-salvar').onclick = async ()=>{
      syncNovoForm();
      const {error} = await supa.from('documentos').upsert(novoDoc);
      if(error) alert('Erro ao salvar: '+error.message);
      else alert('Documento salvo com sucesso!');
    };

    $('novo-novo').onclick = resetNovoForm;
    $('novo-imprimir').onclick = ()=> window.print();

    // EDITAR
    let editDoc = null;
    $('editar-abrir').onclick = async ()=>{
      const id = $('editar-id').value.trim();
      if(!id) return alert('Digite o número do documento');
      const {data,error} = await supa.from('documentos').select('*').eq('id',id).single();
      if(error) return alert('Documento não encontrado');
      editDoc = data;
      loadEditForm();
      $('editar-form').classList.remove('hide');
    };

    function loadEditForm(){
      $('editar-doc').textContent = editDoc.id;
      $('editar-status').textContent = editDoc.status;
      $('ed-numdoc').value = editDoc.id;
      $('ed-data').value = editDoc.data;
      $('ed-status').value = editDoc.status;
      $('ed-origem').value = editDoc.origem;
      $('ed-destino').value = editDoc.destino;
      $('ed-placa').value = editDoc.placa;
      $('ed-motorista').value = editDoc.motorista;
      $('ed-conf-origem').value = editDoc.confOrigem;
      $('ed-obs').value = editDoc.obs;
      $('ed-conf-destino').value = editDoc.confDestino;
      renderEditFotos(); renderEditCarreg(); renderEditDesc();
    }

    function syncEditForm(){
      editDoc.status = $('ed-status').value;
      editDoc.data = $('ed-data').value;
      editDoc.origem = $('ed-origem').value;
      editDoc.destino = $('ed-destino').value;
      editDoc.placa = $('ed-placa').value;
      editDoc.motorista = $('ed-motorista').value;
      editDoc.confOrigem = $('ed-conf-origem').value;
      editDoc.obs = $('ed-obs').value;
      editDoc.confDestino = $('ed-conf-destino').value;
      $('editar-status').textContent = editDoc.status;
    }

    // Fotos (editar)
    function renderEditFotos(){
      const c = $('ed-fotos');
      c.innerHTML = editDoc.fotos.map((f,i)=>`
        <div class="thumb">
          <img src="${f.url}" alt="Foto ${i+1}"/>
          <button onclick="removeEditFoto(${i})">×</button>
          <a href="${f.url}" target="_blank">Ver</a>
        </div>
      `).join('');
    }
    function removeEditFoto(i){ editDoc.fotos.splice(i,1); renderEditFotos(); }
    $('ed-add-foto').onclick = ()=> $('ed-file').click();
    $('ed-file').onchange = async (e)=>{
      for(let file of e.target.files){
        const {data,error} = await supa.storage.from('fotos').upload(`${ts()}-${file.name}`, file);
        if(error) { alert('Erro ao enviar foto: '+error.message); continue; }
        const {data:{publicUrl}} = supa.storage.from('fotos').getPublicUrl(data.path);
        editDoc.fotos.push({url:publicUrl, path:data.path});
      }
      renderEditFotos(); e.target.value='';
    };

    // Carregamento (editar)
    function renderEditCarreg(){
      const tbody = $('ed-carreg').querySelector('tbody');
      tbody.innerHTML = editDoc.carreg.map((item,i)=>`
        <tr>
          <td><input value="${item.desc}" onchange="editDoc.carreg[${i}].desc=this.value"></td>
          <td><input type="number" value="${item.qtd}" onchange="editDoc.carreg[${i}].qtd=+this.value; updateEditTotals()"></td>
          <td><input value="${item.obs}" onchange="editDoc.carreg[${i}].obs=this.value"></td>
          <td class="hide-on-print"><button class="btn danger" onclick="removeEditCarreg(${i})">×</button></td>
        </tr>
      `).join('');
      updateEditTotals();
    }
    function removeEditCarreg(i){ editDoc.carreg.splice(i,1); renderEditCarreg(); }
    function addEditCarreg(){ editDoc.carreg.push({desc:'',qtd:0,obs:''}); renderEditCarreg(); }
    $('ed-add-item').onclick = addEditCarreg;

    // Descarregamento (editar)
    function renderEditDesc(){
      const tbody = $('ed-desc').querySelector('tbody');
      tbody.innerHTML = editDoc.carreg.map((item,i)=>{
        const descItem = editDoc.desc[i] || {qtdReceb:0,obs:''};
        if(!editDoc.desc[i]) editDoc.desc[i] = descItem;
        const diff = descItem.qtdReceb - item.qtd;
        return `
          <tr>
            <td>${item.desc}</td>
            <td><input type="number" value="${descItem.qtdReceb}" onchange="editDoc.desc[${i}].qtdReceb=+this.value; updateEditTotals()"></td>
            <td style="color:${diff<0?'var(--danger)':diff>0?'var(--ok)':'inherit'}">${diff>0?'+':''}${diff}</td>
            <td><input value="${descItem.obs}" onchange="editDoc.desc[${i}].obs=this.value"></td>
          </tr>
        `;
      }).join('');
      updateEditTotals();
    }

    function updateEditTotals(){
      const totalCarreg = editDoc.carreg.reduce((s,x)=>s+x.qtd,0);
      const totalReceb = editDoc.desc.reduce((s,x)=>s+(x.qtdReceb||0),0);
      const totalDiff = totalReceb - totalCarreg;
      $('ed-total-carreg').textContent = totalCarreg;
      $('ed-total-receb').textContent = totalReceb;
      $('ed-total-diff').textContent = (totalDiff>0?'+':'')+totalDiff;
      $('ed-total-diff').style.color = totalDiff<0?'var(--danger)':totalDiff>0?'var(--ok)':'inherit';
    }

    $('editar-salvar').onclick = async ()=>{
      syncEditForm();
      const {error} = await supa.from('documentos').upsert(editDoc);
      if(error) alert('Erro ao salvar: '+error.message);
      else alert('Documento atualizado com sucesso!');
    };

    $('editar-remover').onclick = async ()=>{
      if(!confirm('Tem certeza que deseja excluir este documento?')) return;
      const {error} = await supa.from('documentos').delete().eq('id',editDoc.id);
      if(error) alert('Erro ao excluir: '+error.message);
      else { alert('Documento excluído!'); $('editar-form').classList.add('hide'); $('editar-id').value=''; }
    };

    $('editar-imprimir').onclick = ()=> window.print();

    // PESQUISAR
    $('q-buscar').onclick = async ()=>{
      const doc = $('q-doc').value.trim();
      const placa = $('q-placa').value.trim();
      const motorista = $('q-motorista').value.trim();
      
      let query = supa.from('documentos').select('*');
      if(doc) query = query.ilike('id', `%${doc}%`);
      if(placa) query = query.ilike('placa', `%${placa}%`);
      if(motorista) query = query.ilike('motorista', `%${motorista}%`);
      
      const {data,error} = await query;
      if(error) return alert('Erro na pesquisa: '+error.message);
      
      const tbody = $('q-table').querySelector('tbody');
      tbody.innerHTML = data.map(d=>`
        <tr>
          <td>${d.id}</td>
          <td>${d.data}</td>
          <td>${d.placa}</td>
          <td>${d.motorista}</td>
          <td>${d.status}</td>
          <td><button class="btn ghost" onclick="editarDoc('${d.id}')">Editar</button></td>
        </tr>
      `).join('');
    };

    function editarDoc(id){
      $('editar-id').value = id;
      activate(tabs.editar);
      $('editar-abrir').click();
    }

    $('q-limpar').onclick = ()=>{
      $('q-doc').value = '';
      $('q-placa').value = '';
      $('q-motorista').value = '';
      $('q-table').querySelector('tbody').innerHTML = '';
    };

    // DASHBOARD
    let dashChart = null;
    async function loadDashboard(){
      const de = $('dash-de').value || '2024-01-01';
      const ate = $('dash-ate').value || '2024-12-31';
      
      const {data,error} = await supa.from('documentos')
        .select('*')
        .gte('data', de)
        .lte('data', ate);
      
      if(error) return alert('Erro ao carregar dashboard: '+error.message);
      
      // KPIs
      const totalEnviados = data.reduce((s,d)=>s+d.carreg.reduce((ss,c)=>ss+c.qtd,0),0);
      const totalRecebidos = data.reduce((s,d)=>s+d.desc.reduce((ss,c)=>ss+(c.qtdReceb||0),0),0);
      const quebra = totalEnviados - totalRecebidos;
      
      $('kpi-enviados').textContent = totalEnviados;
      $('kpi-recebidos').textContent = totalRecebidos;
      $('kpi-quebra').textContent = quebra;
      
      // Gráfico
      const ctx = $('dash-chart').getContext('2d');
      if(dashChart) dashChart.destroy();
      
      const chartData = data.map(d=>({
        x: d.data,
        y: d.carreg.reduce((s,c)=>s+c.qtd,0)
      })).sort((a,b)=>a.x.localeCompare(b.x));
      
      dashChart = new Chart(ctx, {
        type: 'line',
        data: {
          datasets: [{
            label: 'Paletes enviados por dia',
            data: chartData,
            borderColor: 'var(--primary)',
            backgroundColor: 'var(--primary-light)',
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          scales: {
            x: { type: 'time', time: { unit: 'day' } },
            y: { beginAtZero: true }
          }
        }
      });
      
      // Tabela detalhada
      const tbody = $('dash-table').querySelector('tbody');
      tbody.innerHTML = data.map(d=>`
        <tr>
          <td>${d.data}</td>
          <td>${d.placa}</td>
          <td>${d.motorista}</td>
          <td>${d.carreg.reduce((s,c)=>s+c.qtd,0)}</td>
          <td>${d.desc.reduce((s,c)=>s+(c.qtdReceb||0),0)}</td>
          <td>${d.confOrigem}</td>
          <td>${d.confDestino}</td>
          <td>${d.status}</td>
        </tr>
      `).join('');
    }

    $('dash-atualizar').onclick = loadDashboard;

    // Inicialização
    resetNovoForm();
    
    // Definir datas padrão do dashboard
    const hoje = new Date();
    const primeiroDia = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
    $('dash-de').value = primeiroDia.toISOString().slice(0,10);
    $('dash-ate').value = hoje.toISOString().slice(0,10);
  </script>
</body>
</html>

