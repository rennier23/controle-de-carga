<!DOCTYPE html>
<html lang="pt-br">
<head>
  <!-- Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://humurozsimozypajncsv.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh1bXVyb3pzaW1venlwYWpuY3N2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUyODE3NzUsImV4cCI6MjA3MDg1Nzc3NX0.uAvgWY1HMvrSGNLaYjaFUQEh5wC8YlfNTRV5J79HVEQ";
    window.supa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  </script>

  <!-- Chart.js + plugin de data labels -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SuperFrio – Controle de Carga</title>
  <style>
    :root{
      --bg:#f3f7fb;--card:#ffffff;--text:#0f172a;--muted:#64748b;--border:#e2e8f0;
      --primary:#148CD6;--primary-dark:#0A6FB9;--danger:#dc2626;--ring: rgba(20,140,214,.35);
      --ok:#16a34a;--ok-100:#dcfce7;--ok-300:#86efac;
      --info:#0ea5e9;--info-100:#e0f2fe;--info-300:#7dd3fc;
      --warn:#f59e0b;--warn-100:#fef3c7;--warn-300:#fcd34d;
      --err:#ef4444;--err-100:#fee2e2;--err-300:#fca5a5;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Arial,sans-serif}
    .wrap{max-width:1100px;margin:0 auto;padding:16px 18px 24px;display:flex;flex-direction:column;gap:14px}

    .brandbar{background:linear-gradient(90deg,#0A6FB9 0%,#148CD6 50%,#1EC7E6 100%);padding:14px 18px;color:#fff;border-bottom:1px solid #dbeafe;box-shadow:0 6px 20px rgba(10,111,185,.15);}
    .brandbar .row{display:flex;align-items:center;gap:14px;flex-wrap:wrap;justify-content:space-between}
    .logo{display:flex;align-items:center;gap:12px}
    .logo img{height:38px;width:auto;display:block;filter:drop-shadow(0 1px 2px rgba(0,0,0,.15));background:transparent}
    .logo h1{margin:0;font-size:20px;letter-spacing:.3px;font-weight:700}
    .tagline{margin:0;font-size:12px;opacity:.9;letter-spacing:.2px}

    nav{display:flex;gap:10px;flex-wrap:wrap}
    nav button{border:1px solid rgba(255,255,255,.5);background:rgba(255,255,255,.12);color:#fff;padding:8px 12px;border-radius:10px;cursor:pointer;backdrop-filter:blur(2px);}
    nav button.active{background:#fff;color:var(--primary-dark);border-color:#fff}

    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px}
    label{display:block;font-size:13px;margin-bottom:6px;color:#0f172a}
    input,textarea,select{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;font-size:14px;background:#fff;outline:none;box-shadow:0 0 0 0 rgba(0,0,0,0);}
    input:focus,textarea:focus,select:focus{border-color:var(--primary);box-shadow:0 0 0 3px var(--ring)}
    textarea{min-height:90px;resize:vertical}
    .grid{display:grid;gap:10px}.g2{grid-template-columns:repeat(2,1fr)}.g3{grid-template-columns:repeat(3,1fr)}
    .actions{display:flex;gap:10px;flex-wrap:wrap}
    .btn{background:var(--primary-dark);color:#fff;border:none;border-radius:10px;padding:9px 12px;cursor:pointer}
    .btn.ghost{background:#fff;color:var(--primary-dark);border:1px solid var(--primary-dark)}
    .btn.danger{background:var(--danger)}
    .pill{border:1px solid var(--border);border-radius:999px;padding:6px 10px;font-size:12px;color:#0f172a;background:#f8fafc}

    table{width:100%;border-collapse:separate;border-spacing:0;border:1px solid var(--border);border-radius:12px;overflow:hidden}
    th,td{padding:10px;border-bottom:1px solid var(--border);background:#fff;text-align:left;font-size:14px}
    th{background:#eff6ff;color:#0b3b66}
    tr:last-child td{border-bottom:none}

    .muted{color:var(--muted);font-size:12px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .hide{display:none !important}

    /* KPI CARDS coloridos */
    .kpis{display:grid;gap:12px;grid-template-columns:repeat(3,1fr)}
    .kpi{border-radius:12px;padding:16px;border:1px solid var(--border);background:#fff;box-shadow:0 4px 14px rgba(0,0,0,.04)}
    .kpi--blue{background:linear-gradient(180deg,var(--info-100),#fff) !important;border-color:var(--info-300) !important}
    .kpi--green{background:linear-gradient(180deg,var(--ok-100),#fff) !important;border-color:var(--ok-300) !important}
    .kpi--red{background:linear-gradient(180deg,var(--err-100),#fff) !important;border-color:var(--err-300) !important}
    .kpi .title{color:var(--muted);font-size:13px;margin-bottom:8px}
    .kpi .value{font-size:30px;font-weight:800}

    /* Tamanhos/estilos dos gráficos */
    .chart-card{display:flex;justify-content:center;align-items:center}
    .chart-sm{max-width:340px;max-height:340px;margin:0 auto;display:block;}

    /* Responsivo */
    @media (max-width:860px){
      .g3{grid-template-columns:1fr}
      .g2{grid-template-columns:1fr}
      .kpis{grid-template-columns:1fr}
    }
    @media print{.brandbar,nav,.actions,.muted,.hide-on-print{display:none!important};.wrap{gap:6px;padding:0 10px}}
  </style>
</head>
<body>
  <div class="brandbar">
    <div class="row">
      <div class="logo">
        <!-- Use sua imagem/base64 real aqui -->
        <img src="https://dummyimage.com/140x38/148cd6/ffffff&text=SuperFrio" alt="SuperFrio logo"/>
        <div>
          <h1>SuperFrio – Controle de Carga</h1>
          <p class="tagline">Logística Frigorificada • Carregamento & Descarregamento</p>
        </div>
      </div>
      <nav>
        <button id="tab-novo" class="active">Novo</button>
        <button id="tab-editar">Editar</button>
        <button id="tab-pesquisar">Pesquisar</button>
        <button id="tab-dash">Dashboard</button>
      </nav>
    </div>
  </div>

  <div class="wrap">
    <!-- NOVO -->
    <section id="page-novo" class="card">
      <div class="row" style="justify-content:space-between">
        <div class="pill">Documento: <b id="novo-doc"></b> • Status: <b id="novo-status"></b></div>
        <div class="actions">
          <button class="btn" id="novo-salvar">Salvar</button>
          <button class="btn ghost" id="novo-novo">Novo Doc</button>
          <button class="btn ghost" id="novo-imprimir">Imprimir / PDF</button>
        </div>
      </div>

      <h3>Identificação</h3>
      <div class="grid g3">
        <div><label>Nº Documento (auto)</label><input id="novo-numdoc" readonly></div>
        <div><label>Data carregamento</label><input type="date" id="novo-data"/></div>
        <div>
          <label>Status</label>
          <select id="novo-status-select">
            <option>Em trânsito</option>
            <option>Carregando</option>
            <option>Recebido</option>
          </select>
        </div>
        <div><label>Unidade Origem</label><input id="novo-origem" value="RJ"/></div>
        <div><label>Unidade Destino</label><input id="novo-destino"/></div>
        <div><label>Placa</label><input id="novo-placa" placeholder="Ex.: ABC1D23"/></div>
        <div><label>Motorista</label><input id="novo-motorista"/></div>
        <div><label>Conferente (carregamento)</label><input id="novo-conf-origem"/></div>
        <div class="g2" style="grid-column:1/-1"><label>Observações</label><input id="novo-obs"/></div>
      </div>

      <h3 style="margin-top:12px">Carregamento</h3>
      <table id="novo-carreg">
        <thead><tr><th>Descrição</th><th>Qtd (pallets)</th><th>Observações</th><th class="hide-on-print"></th></tr></thead>
        <tbody></tbody>
      </table>
      <div class="row" style="justify-content:space-between;margin-top:8px">
        <button class="btn ghost" id="novo-add-item">+ Adicionar item</button>
        <div class="pill">Total carregado: <b id="novo-total-carreg">0</b></div>
      </div>

      <h3 style="margin-top:12px">Descarregamento</h3>
      <table id="novo-desc">
        <thead><tr><th>Descrição</th><th>Qtd Recebida</th><th>Diferença</th><th>Observações</th></tr></thead>
        <tbody></tbody>
      </table>
      <div class="grid g2" style="margin-top:8px">
        <div><label>Conferente (descarregamento)</label><input id="novo-conf-destino"/></div>
        <div class="row" style="justify-content:flex-end"><div class="pill">Total recebido: <b id="novo-total-receb">0</b> • Diferença total: <b id="novo-total-diff">0</b></div></div>
      </div>
    </section>

    <!-- EDITAR -->
    <section id="page-editar" class="card hide">
      <div class="row">
        <input id="editar-id" placeholder="Digite nº do documento…"/>
        <button class="btn" id="editar-abrir">Abrir</button>
        <button class="btn ghost" id="editar-remover">Excluir</button>
      </div>
      <div id="editar-form" class="hide">
        <div class="row" style="justify-content:space-between;margin-top:8px">
          <div class="pill">Documento: <b id="editar-doc"></b> • Status: <b id="editar-status"></b></div>
          <div class="actions">
            <button class="btn" id="editar-salvar">Salvar</button>
            <button class="btn ghost" id="editar-imprimir">Imprimir / PDF</button>
          </div>
        </div>

        <h3>Identificação</h3>
        <div class="grid g3">
          <div><label>Nº Documento</label><input id="ed-numdoc" readonly></div>
          <div><label>Data carregamento</label><input type="date" id="ed-data"/></div>
          <div>
            <label>Status</label>
            <select id="ed-status">
              <option>Em trânsito</option>
              <option>Carregando</option>
              <option>Recebido</option>
            </select>
          </div>
          <div><label>Unidade Origem</label><input id="ed-origem"/></div>
          <div><label>Unidade Destino</label><input id="ed-destino"/></div>
          <div><label>Placa</label><input id="ed-placa"/></div>
          <div><label>Motorista</label><input id="ed-motorista"/></div>
          <div><label>Conferente (carregamento)</label><input id="ed-conf-origem"/></div>
          <div class="g2" style="grid-column:1/-1"><label>Observações</label><input id="ed-obs"/></div>
        </div>

        <h3 style="margin-top:12px">Carregamento</h3>
        <table id="ed-carreg">
          <thead><tr><th>Descrição</th><th>Qtd (pallets)</th><th>Observações</th><th class="hide-on-print"></th></tr></thead>
          <tbody></tbody>
        </table>
        <div class="row" style="justify-content:space-between;margin-top:8px">
          <button class="btn ghost" id="ed-add-item">+ Adicionar item</button>
          <div class="pill">Total carregado: <b id="ed-total-carreg">0</b></div>
        </div>

        <h3 style="margin-top:12px">Descarregamento</h3>
        <table id="ed-desc">
          <thead><tr><th>Descrição</th><th>Qtd Recebida</th><th>Diferença</th><th>Observações</th></tr></thead>
          <tbody></tbody>
        </table>
        <div class="grid g2" style="margin-top:8px">
          <div><label>Conferente (descarregamento)</label><input id="ed-conf-destino"/></div>
          <div class="row" style="justify-content:flex-end"><div class="pill">Total recebido: <b id="ed-total-receb">0</b> • Diferença total: <b id="ed-total-diff">0</b></div></div>
        </div>
      </div>
    </section>

    <!-- PESQUISAR -->
    <section id="page-pesquisar" class="card hide">
      <div class="grid g3">
        <div><label>Nº Documento</label><input id="q-doc"/></div>
        <div><label>Placa</label><input id="q-placa"/></div>
        <div><label>Motorista</label><input id="q-motorista"/></div>
      </div>
      <div class="actions" style="margin-top:8px">
        <button class="btn" id="q-buscar">Pesquisar</button>
        <button class="btn ghost" id="q-limpar">Limpar</button>
      </div>
      <div style="margin-top:10px">
        <table id="q-table">
          <thead><tr><th>Documento</th><th>Data</th><th>Placa</th><th>Motorista</th><th>Status</th><th>Ações</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- DASHBOARD -->
    <section id="page-dash" class="card hide">
      <div class="row" style="justify-content:space-between">
        <h3 style="margin:0">Dashboard</h3>
        <div class="row">
          <div>
            <label>De</label>
            <input type="date" id="dash-de">
          </div>
          <div>
            <label>Até</label>
            <input type="date" id="dash-ate">
          </div>
          <button class="btn" id="dash-atualizar" style="align-self:flex-end">Atualizar</button>
        </div>
      </div>

      <div class="kpis" style="margin-top:10px">
        <div class="kpi kpi--blue">
          <div class="title">Paletes enviados</div>
          <div class="value" id="kpi-enviados">0</div>
        </div>
        <div class="kpi kpi--green">
          <div class="title">Paletes recebidos</div>
          <div class="value" id="kpi-recebidos">0</div>
        </div>
        <div class="kpi kpi--red">
          <div class="title">Quebra</div>
          <div class="value" id="kpi-quebra">0</div>
        </div>
      </div>

      <div class="card" style="margin-top:10px">
        <canvas id="dash-chart" height="120"></canvas>
      </div>

      <div class="card chart-card" style="margin-top:10px">
        <div style="width:100%;display:flex;justify-content:center">
          <div style="width:100%;max-width:380px">
            <h4 style="margin:0 0 8px 0;text-align:center">Status dos documentos</h4>
            <canvas id="status-chart" class="chart-sm"></canvas>
          </div>
        </div>
      </div>
    </section>
  </div>

  <script>
    const $ = (id)=>document.getElementById(id);

    // Abas
    const tabs={
      novo:{btn:$('tab-novo'),page:$('page-novo')},
      editar:{btn:$('tab-editar'),page:$('page-editar')},
      pesq:{btn:$('tab-pesquisar'),page:$('page-pesquisar')},
      dash:{btn:$('tab-dash'),page:$('page-dash')}
    };
    function activate(t){
      Object.values(tabs).forEach(x=>{x.btn.classList.remove('active');x.page.classList.add('hide');});
      t.btn.classList.add('active'); t.page.classList.remove('hide');
    }
    Object.values(tabs).forEach(t=> t.btn.addEventListener('click', async ()=>{
      const isDash = (t===tabs.dash);
      activate(t);
      if(t===tabs.novo) resetNovoForm();
      if(isDash) await loadDashboard();
    }));

    // ID do documento
    function genDocId(date = new Date()){
      const y = date.getFullYear(), m = date.getMonth()+1, d = date.getDate();
      const L='ABCDEFGHIJKLMNOPQRSTUVWXYZ';
      let a=L[Math.floor(Math.random()*26)], b=L[Math.floor(Math.random()*26)];
      while(a===b) b=L[Math.floor(Math.random()*26)];
      return `${y}${m}${d}${a}${b}`;
    }

    // Estado NOVO
    function newDocData(){
      return {id:genDocId(), status:'Em trânsito', data:new Date().toISOString().slice(0,10),
        origem:'RJ', destino:'', placa:'', motorista:'', confOrigem:'', confDestino:'', obs:'', itens:[]};
    }
    let novo = newDocData();
    function resetNovoForm(){ novo=newDocData(); renderNovo(); ensureDefaultsNovo(); }

    // --------- Supabase I/O ---------
    async function saveDoc(doc){
      const row = {
        id: doc.id, data: doc.data || null, placa: doc.placa || null,
        motorista: doc.motorista || null, status: doc.status || null, payload: doc
      };
      const { error } = await supa.from('docs').upsert(row);
      if(error){ console.error(error); alert('Erro ao salvar: '+error.message); }
      else { alert('Salvo! Nº '+doc.id); }
    }
    async function getDoc(id){
      const { data, error } = await supa.from('docs').select('payload').eq('id', id).maybeSingle();
      if(error){ console.error(error); alert('Erro ao buscar: '+error.message); return null; }
      return data ? data.payload : null;
    }
    async function delDoc(id){
      const { error } = await supa.from('docs').delete().eq('id', id);
      if(error){ console.error(error); alert('Erro ao excluir: '+error.message); }
      else { alert('Excluído.'); }
    }
    async function allDocs(filters = {}){
      let q = supa.from('docs').select('id,data,placa,motorista,status').order('data',{ascending:false});
      if(filters.id)        q = q.ilike('id', `%${filters.id}%`);
      if(filters.placa)     q = q.ilike('placa', `%${filters.placa}%`);
      if(filters.motorista) q = q.ilike('motorista', `%${filters.motorista}%`);
      const { data, error } = await q;
      if(error){ console.error(error); alert('Erro ao listar: '+error.message); return []; }
      return data;
    }
    // --------------------------------

    // NOVO
    function renderNovo(){
      $('novo-doc').textContent=novo.id; $('novo-status').textContent=novo.status;
      $('novo-numdoc').value=novo.id; $('novo-data').value=novo.data||'';
      $('novo-status-select').value=novo.status||'Em trânsito';
      $('novo-origem').value=novo.origem||''; $('novo-destino').value=novo.destino||'';
      $('novo-placa').value=novo.placa||''; $('novo-motorista').value=novo.motorista||'';
      $('novo-conf-origem').value=novo.confOrigem||''; $('novo-conf-destino').value=novo.confDestino||''; $('novo-obs').value=novo.obs||'';

      const tbC=document.querySelector('#novo-carreg tbody'), tbD=document.querySelector('#novo-desc tbody'); tbC.innerHTML=''; tbD.innerHTML='';
      novo.itens.forEach(it=>{
        tbC.insertAdjacentHTML('beforeend',
        `<tr data-row="${it.id}">
          <td><input id="n-desc-${it.id}" value="${it.desc||''}"></td>
          <td><input id="n-qtd-${it.id}" type="number" min="0" value="${it.qtd!==''?it.qtd:''}"></td>
          <td><input id="n-obs-${it.id}" value="${it.obs||''}"></td>
          <td class="hide-on-print"><button class="btn danger" data-rm="${it.id}">Remover</button></td>
        </tr>`);
        const diff=(Number(it.recebida||0)-Number(it.qtd||0));
        tbD.insertAdjacentHTML('beforeend',
        `<tr data-rowd="${it.id}">
          <td><span id="n-desc-view-${it.id}">${it.desc||''}</span></td>
          <td><input id="n-rec-${it.id}" type="number" min="0" value="${it.recebida!==''?it.recebida:''}"></td>
          <td><span id="n-diff-${it.id}">${diff}</span></td>
          <td><input id="n-obsd-${it.id}" value="${it.obs||''}"></td>
        </tr>`);
        hookNovoRow(it.id);
      });
      updateNovoTotals();
    }
    function hookNovoRow(id){
      const desc=$('n-desc-'+id), qtd=$('n-qtd-'+id), obs=$('n-obs-'+id),
            rec=$('n-rec-'+id), obsd=$('n-obsd-'+id),
            viewDesc=$('n-desc-view-'+id), diffEl=$('n-diff-'+id);
      function recalc(){
        const it=novo.itens.find(x=>x.id===id);
        const diff=(Number(it.recebida||0)-Number(it.qtd||0));
        diffEl.textContent=diff; viewDesc.textContent=it.desc||''; updateNovoTotals();
      }
      desc.addEventListener('input', e=>{ const it=novo.itens.find(x=>x.id===id); it.desc=e.target.value; viewDesc.textContent=it.desc; });
      qtd.addEventListener('input', e=>{ const it=novo.itens.find(x=>x.id===id); it.qtd=e.target.value===''? '' : Number(e.target.value); recalc(); });
      obs.addEventListener('input', e=>{ const it=novo.itens.find(x=>x.id===id); it.obs=e.target.value; obsd.value=it.obs; });
      rec.addEventListener('input', e=>{ const it=novo.itens.find(x=>x.id===id); it.recebida=e.target.value===''? '' : Number(e.target.value); recalc(); });
      obsd.addEventListener('input', e=>{ const it=novo.itens.find(x=>x.id===id); it.obs=e.target.value; obs.value=it.obs; });
      document.querySelector(`[data-rm="${id}"]`)?.addEventListener('click', ()=>{
        novo.itens = novo.itens.filter(x=>x.id!==id); renderNovo();
      });
    }
    function updateNovoTotals(){
      const tc=novo.itens.reduce((a,b)=>a+(Number(b.qtd)||0),0);
      const tr=novo.itens.reduce((a,b)=>a+(Number(b.recebida)||0),0);
      $('novo-total-carreg').textContent=tc;
      $('novo-total-receb').textContent=tr;
      $('novo-total-diff').textContent=tr-tc;
    }
    $('novo-add-item').addEventListener('click', ()=>{
      const id=genDocId(); novo.itens.push({id,desc:'',qtd:'',obs:'',recebida:''});
      const tbC=document.querySelector('#novo-carreg tbody'), tbD=document.querySelector('#novo-desc tbody');
      tbC.insertAdjacentHTML('beforeend',
      `<tr data-row="${id}">
        <td><input id="n-desc-${id}"></td>
        <td><input id="n-qtd-${id}" type="number" min="0"></td>
        <td><input id="n-obs-${id}"></td>
        <td class="hide-on-print"><button class="btn danger" data-rm="${id}">Remover</button></td>
      </tr>`);
      tbD.insertAdjacentHTML('beforeend',
      `<tr data-rowd="${id}">
        <td><span id="n-desc-view-${id}"></span></td>
        <td><input id="n-rec-${id}" type="number" min="0"></td>
        <td><span id="n-diff-${id}">0</span></td>
        <td><input id="n-obsd-${id}"></td>
      </tr>`);
      hookNovoRow(id); updateNovoTotals();
    });

    // Inputs topo (Novo)
    ['novo-data','novo-origem','novo-destino','novo-placa','novo-motorista','novo-conf-origem','novo-conf-destino','novo-obs'].forEach(id=>{
      $(id).addEventListener('input', e=>{
        const v=e.target.value; if(id==='novo-data') novo.data=v;
        else if(id==='novo-origem') novo.origem=v;
        else if(id==='novo-destino') novo.destino=v;
        else if(id==='novo-placa') novo.placa=v;
        else if(id==='novo-motorista') novo.motorista=v;
        else if(id==='novo-conf-origem') novo.confOrigem=v;
        else if(id==='novo-conf-destino') novo.confDestino=v;
        else if(id==='novo-obs') novo.obs=v;
      });
    });
    $('novo-status-select').addEventListener('change', e=>{ novo.status=e.target.value; $('novo-status').textContent=novo.status; });
    $('novo-salvar').addEventListener('click', async ()=>{ await saveDoc(novo); });
    $('novo-novo').addEventListener('click', resetNovoForm);
    $('novo-imprimir').addEventListener('click', ()=>window.print());

    // EDITAR
    let editing=null;
    $('editar-abrir').addEventListener('click', async ()=>{
      const id=$('editar-id').value.trim();
      const doc=await getDoc(id);
      if(!doc){alert('Documento não encontrado.'); return;}
      editing=doc; $('editar-form').classList.remove('hide'); renderEditar();
    });
    $('editar-remover').addEventListener('click', async ()=>{
      const id=$('editar-id').value.trim(); if(!id) return;
      if(confirm('Excluir documento '+id+'?')){ await delDoc(id); $('editar-form').classList.add('hide'); }
    });
    function renderEditar(){
      $('editar-doc').textContent=editing.id; $('editar-status').textContent=editing.status;
      $('ed-numdoc').value=editing.id; $('ed-data').value=editing.data||'';
      $('ed-status').value=editing.status||'Em trânsito';
      $('ed-origem').value=editing.origem||''; $('ed-destino').value=editing.destino||''; $('ed-placa').value=editing.placa||''; $('ed-motorista').value=editing.motorista||'';
      $('ed-conf-origem').value=editing.confOrigem||''; $('ed-conf-destino').value=editing.confDestino||''; $('ed-obs').value=editing.obs||'';

      const tbC=document.querySelector('#ed-carreg tbody'), tbD=document.querySelector('#ed-desc tbody'); tbC.innerHTML=''; tbD.innerHTML='';
      editing.itens.forEach(it=>{
        tbC.insertAdjacentHTML('beforeend',
        `<tr data-row="${it.id}">
          <td><input id="e-desc-${it.id}" value="${it.desc||''}"></td>
          <td><input id="e-qtd-${it.id}" type="number" min="0" value="${it.qtd!==''?it.qtd:''}"></td>
          <td><input id="e-obs-${it.id}" value="${it.obs||''}"></td>
          <td class="hide-on-print"><button class="btn danger" data-rme="${it.id}">Remover</button></td>
        </tr>`);
        const diff=(Number(it.recebida||0)-Number(it.qtd||0));
        tbD.insertAdjacentHTML('beforeend',
        `<tr data-rowd="${it.id}">
          <td><span id="e-desc-view-${it.id}">${it.desc||''}</span></td>
          <td><input id="e-rec-${it.id}" type="number" min="0" value="${it.recebida!==''?it.recebida:''}"></td>
          <td><span id="e-diff-${it.id}">${diff}</span></td>
          <td><input id="e-obsd-${it.id}" value="${it.obs||''}"></td>
        </tr>`);
        hookEditarRow(it.id);
      });
      updateEditarTotals();
    }
    function hookEditarRow(id){
      const desc=$('e-desc-'+id), qtd=$('e-qtd-'+id), obs=$('e-obs-'+id),
            rec=$('e-rec-'+id), obsd=$('e-obsd-'+id),
            viewDesc=$('e-desc-view-'+id), diffEl=$('e-diff-'+id);
      function recalc(){const it=editing.itens.find(x=>x.id===id); const diff=(Number(it.recebida||0)-Number(it.qtd||0)); diffEl.textContent=diff; viewDesc.textContent=it.desc||''; updateEditarTotals();}
      desc.addEventListener('input', e=>{ const it=editing.itens.find(x=>x.id===id); it.desc=e.target.value; viewDesc.textContent=it.desc; });
      qtd.addEventListener('input', e=>{ const it=editing.itens.find(x=>x.id===id); it.qtd=e.target.value===''? '' : Number(e.target.value); recalc(); });
      obs.addEventListener('input', e=>{ const it=editing.itens.find(x=>x.id===id); it.obs=e.target.value; obsd.value=it.obs; });
      rec.addEventListener('input', e=>{ const it=editing.itens.find(x=>x.id===id); it.recebida=e.target.value===''? '' : Number(e.target.value); recalc(); });
      obsd.addEventListener('input', e=>{ const it=editing.itens.find(x=>x.id===id); it.obs=e.target.value; obs.value=it.obs; });
      document.querySelector(`[data-rme="${id}"]`)?.addEventListener('click', ()=>{
        editing.itens = editing.itens.filter(x=>x.id!==id); renderEditar();
      });
    }
    function updateEditarTotals(){
      const tc=editing.itens.reduce((a,b)=>a+(Number(b.qtd)||0),0);
      const tr=editing.itens.reduce((a,b)=>a+(Number(b.recebida)||0),0);
      $('ed-total-carreg').textContent=tc;
      $('ed-total-receb').textContent=tr;
      $('ed-total-diff').textContent=tr-tc;
    }
    $('editar-salvar').addEventListener('click', async ()=>{ if(!editing) return; await saveDoc(editing); alert('Atualizado!'); });
    $('editar-imprimir').addEventListener('click', ()=>window.print());
    ['ed-data','ed-origem','ed-destino','ed-placa','ed-motorista','ed-conf-origem','ed-conf-destino','ed-obs'].forEach(id=>{
      $(id).addEventListener('input', e=>{
        if(!editing) return; const v=e.target.value;
        if(id==='ed-data') editing.data=v;
        else if(id==='ed-origem') editing.origem=v;
        else if(id==='ed-destino') editing.destino=v;
        else if(id==='ed-placa') editing.placa=v;
        else if(id==='ed-motorista') editing.motorista=v;
        else if(id==='ed-conf-origem') editing.confOrigem=v;
        else if(id==='ed-conf-destino') editing.confDestino=v;
        else if(id==='ed-obs') editing.obs=v;
      });
    });
    $('ed-status').addEventListener('change', e=>{ if(!editing) return; editing.status=e.target.value; $('editar-status').textContent=editing.status; });

    // PESQUISAR
    $('q-buscar').addEventListener('click', async ()=>{
      const rows = await allDocs({
        id: $('q-doc').value.trim().toUpperCase(),
        placa: $('q-placa').value.trim().toUpperCase(),
        motorista: $('q-motorista').value.trim().toUpperCase()
      });
      renderSearch(rows);
    });
    $('q-limpar').addEventListener('click', ()=>{ $('q-doc').value=''; $('q-placa').value=''; $('q-motorista').value=''; renderSearch([]); });

    function renderSearch(rows){
      const tb=document.querySelector('#q-table tbody'); tb.innerHTML='';
      rows.forEach(d=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `<td>${d.id}</td><td>${d.data||''}</td><td>${d.placa||''}</td><td>${d.motorista||''}</td><td>${d.status||''}</td>
          <td><button class='btn ghost' data-open='${d.id}'>Editar</button></td>`;
        tb.appendChild(tr);
      });
      tb.querySelectorAll('button[data-open]').forEach(b=> b.addEventListener('click', async (e)=>{
        const id=e.target.getAttribute('data-open');
        tabs.editar.btn.click();
        $('editar-id').value = id;
        const doc = await getDoc(id);
        if(!doc){ alert('Documento não encontrado.'); return; }
        editing = doc; $('editar-form').classList.remove('hide'); renderEditar();
      }));
    }

    // DASHBOARD
    let dashChart = null, statusChart = null;

    function sumFromDocs(docs){
      let enviados = 0, recebidos = 0, quebra = 0;
      const porDia = {}; // { 'yyyy-mm-dd': {env, rec, qbr} }
      for(const d of docs){
        const dataDia = d.data || 'SemData';
        if(!porDia[dataDia]) porDia[dataDia] = {env:0, rec:0, qbr:0};
        const itens = (d.payload && d.payload.itens) ? d.payload.itens : [];
        for(const it of itens){
          const q = Number(it.qtd||0);
          const r = Number(it.recebida||0);
          enviados += q;
          recebidos += r;
          const qbr = Math.max(0, q - r);
          quebra += qbr;
          porDia[dataDia].env += q;
          porDia[dataDia].rec += r;
          porDia[dataDia].qbr += qbr;
        }
      }
      return {enviados, recebidos, quebra, porDia};
    }
    function statusCounts(rows){
      const map = {'Em trânsito':0, 'Carregando':0, 'Recebido':0};
      for(const r of rows){
        const s = r.status || 'Em trânsito';
        if(map[s]===undefined) map[s]=0;
        map[s]++;
      }
      return map;
    }

    async function loadDashboard(){
      const de  = $('dash-de').value;
      const ate = $('dash-ate').value;

      let q = supa.from('docs').select('data,payload,status').order('data', {ascending:true});
      if(de)  q = q.gte('data', de);
      if(ate) q = q.lte('data', ate);
      const { data, error } = await q;
      if(error){ console.error(error); alert('Erro ao carregar dashboard: '+error.message); return; }

      // KPIs & linha
      const agg = sumFromDocs(data);
      $('kpi-enviados').textContent = agg.enviados;
      $('kpi-recebidos').textContent = agg.recebidos;
      $('kpi-quebra').textContent   = agg.quebra;

      const dias = Object.keys(agg.porDia).sort();
      const serieEnv = dias.map(d=>agg.porDia[d].env);
      const serieRec = dias.map(d=>agg.porDia[d].rec);
      const serieQbr = dias.map(d=>agg.porDia[d].qbr);

      const ctx = document.getElementById('dash-chart').getContext('2d');
      if(dashChart) dashChart.destroy();
      dashChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: dias,
          datasets: [
            { label: 'Enviados',  data: serieEnv },
            { label: 'Recebidos', data: serieRec },
            { label: 'Quebra',    data: serieQbr }
          ]
        },
        options: {
          responsive: true,
          plugins: { legend: { position: 'top' } },
          interaction: { mode:'index', intersect:false },
          scales: { y: { beginAtZero: true } }
        }
      });

      // Pizza de status (menor + rótulos)
      const counts = statusCounts(data);
      const sctx = document.getElementById('status-chart').getContext('2d');
      if(statusChart) statusChart.destroy();
      statusChart = new Chart(sctx, {
        type: 'doughnut',
        data: {
          labels: ['Em trânsito','Carregando','Recebido'],
          datasets: [{
            data: [
              counts['Em trânsito']||0,
              counts['Carregando']||0,
              counts['Recebido']||0
            ],
            backgroundColor: ['#60a5fa','#fbbf24','#34d399'],
            borderColor: ['#3b82f6','#f59e0b','#10b981'],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          cutout: '60%',
          plugins: {
            legend: { position: 'bottom' },
            datalabels: {
              color: '#111827',
              font: { weight:'700' },
              formatter: (value, ctx) => {
                const data = ctx.chart.data.datasets[0].data;
                const total = data.reduce((a,b)=>a+b,0) || 1;
                const pct = (value*100/total).toFixed(0) + '%';
                return value ? pct : '';
              }
            }
          }
        },
        plugins: [ChartDataLabels]
      });
    }
    $('dash-atualizar')?.addEventListener('click', loadDashboard);

    // Inicialização
    function ensureDefaultsNovo(){ if(novo.itens.length===0){ const id=genDocId(); novo.itens.push({id,desc:'',qtd:'',obs:'',recebida:''}); renderNovo(); } }
    resetNovoForm();
  </script>
</body>
</html>
