<!DOCTYPE html>
<html lang="pt-br">
<head>
  <!-- Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://humurozsimozypajncsv.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh1bXVyb3pzaW1venlwYWpuY3N2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUyODE3NzUsImV4cCI6MjA3MDg1Nzc3NX0.uAvgWY1HMvrSGNLaYjaFUQEh5wC8YlfNTRV5J79HVEQ";
    window.supa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  </script>

  <!-- Chart.js (para o gráfico de linha do dashboard) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>

  <!-- Font Awesome para ícones -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SuperFrio – Controle de Carga</title>
  <style>
    :root{
      --bg:#f3f7fb;--card:#ffffff;--text:#0f172a;--muted:#64748b;--border:#e2e8f0;
      --primary:#148CD6;--primary-dark:#0A6FB9;--danger:#dc2626;--ring: rgba(20,140,214,.35);
      --ok:#16a34a;--ok-100:#dcfce7;--ok-300:#86efac;
      --info:#0ea5e9;--info-100:#e0f2fe;--info-300:#7dd3fc;
      --warn:#f59e0b;--warn-100:#fef3c7;--warn-300:#fcd34d;
      --err:#ef4444;--err-100:#fee2e2;--err-300:#fca5a5;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Arial,sans-serif}
    .wrap{max-width:1100px;margin:0 auto;padding:16px 18px 24px;display:flex;flex-direction:column;gap:14px}

    .brandbar{background:linear-gradient(90deg,#0A6FB9 0%,#148CD6 50%,#1EC7E6 100%);padding:14px 18px;color:#fff;border-bottom:1px solid #dbeafe;box-shadow:0 6px 20px rgba(10,111,185,.15);}
    .brandbar .row{display:flex;align-items:center;gap:14px;flex-wrap:wrap;justify-content:space-between}
    .logo{display:flex;align-items:center;gap:12px}
    .logo img{height:38px;width:auto;display:block;filter:drop-shadow(0 1px 2px rgba(0,0,0,.15));background:transparent}
    .logo h1{margin:0;font-size:20px;letter-spacing:.3px;font-weight:700}
    .tagline{margin:0;font-size:12px;opacity:.9;letter-spacing:.2px}

    nav{display:flex;gap:10px;flex-wrap:wrap}
    nav button{border:1px solid rgba(255,255,255,.5);background:rgba(255,255,255,.12);color:#fff;padding:8px 12px;border-radius:10px;cursor:pointer;backdrop-filter:blur(2px);display:flex;align-items:center;gap:6px;font-weight:500;}
    nav button.active{background:#fff;color:var(--primary-dark);border-color:#fff}
    nav button i{margin-right:2px}

    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px;box-shadow:0 4px 14px rgba(0,0,0,.04)}
    label{display:block;font-size:13px;margin-bottom:6px;color:#0f172a}
    input,textarea,select{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;font-size:14px;background:#fff;outline:none;box-shadow:0 0 0 0 rgba(0,0,0,0);}
    input:focus,textarea:focus,select:focus{border-color:var(--primary);box-shadow:0 0 0 3px var(--ring)}
    textarea{min-height:90px;resize:vertical}
    .grid{display:grid;gap:10px}.g2{grid-template-columns:repeat(2,1fr)}.g3{grid-template-columns:repeat(3,1fr)}
    .actions{display:flex;gap:10px;flex-wrap:wrap}
    .btn{background:var(--primary-dark);color:#fff;border:none;border-radius:10px;padding:9px 12px;cursor:pointer;display:flex;align-items:center;gap:6px;font-weight:500}
    .btn i{margin-right:4px}
    .btn.ghost{background:#fff;color:var(--primary-dark);border:1px solid var(--primary-dark)}
    .btn.danger{
      /* Botão de ações perigosas (excluir) com fundo vermelho e texto branco */
      background:var(--danger);
      color:#fff;
      border:1px solid var(--danger);
    }
    .pill{border:1px solid var(--border);border-radius:999px;padding:6px 10px;font-size:12px;color:#0f172a;background:#f8fafc}

    table{width:100%;border-collapse:separate;border-spacing:0;border:1px solid var(--border);border-radius:12px;overflow:hidden}
    th,td{padding:10px;border-bottom:1px solid var(--border);background:#fff;text-align:left;font-size:14px}
    th{background:#eff6ff;color:#0b3b66;font-weight:600}
    tr:last-child td{border-bottom:none}

    .table-wrap{overflow:auto}
    .muted{color:var(--muted);font-size:12px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .hide{display:none !important}

    /* KPI CARDS coloridos */
    .kpis{display:grid;gap:12px;grid-template-columns:repeat(3,1fr)}
    .kpi{border-radius:12px;padding:16px;border:1px solid var(--border);background:#fff;box-shadow:0 4px 14px rgba(0,0,0,.04)}
    .kpi--blue{background:linear-gradient(180deg,var(--info-100),#fff) !important;border-color:var(--info-300) !important}
    .kpi--green{background:linear-gradient(180deg,var(--ok-100),#fff) !important;border-color:var(--ok-300) !important}
    .kpi--red{background:linear-gradient(180deg,var(--err-100),#fff) !important;border-color:var(--err-300) !important}
    .kpi .title{color:var(--muted);font-size:13px;margin-bottom:8px}
    .kpi .value{font-size:30px;font-weight:800}

    /* Fotos */
    .photo-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:10px}
    .thumb{position:relative;border:1px solid var(--border);border-radius:10px;overflow:hidden;background:#fff}
    .thumb img{display:block;width:100%;height:100%;object-fit:cover;aspect-ratio:1/1}
    .thumb button{position:absolute;top:6px;right:6px;background:#fff;color:#111;border:1px solid var(--border);border-radius:8px;padding:4px 7px;font-size:12px;cursor:pointer}
    .thumb a{position:absolute;left:6px;bottom:6px;background:#ffffffd9;border:1px solid var(--border);border-radius:6px;padding:3px 6px;font-size:11px;text-decoration:none;color:#0b3b66}

    /* Ícones em títulos */
    h3 i, h4 i{color:var(--primary-dark);margin-right:6px}

    @media (max-width:860px){
      .g3{grid-template-columns:1fr}
      .g2{grid-template-columns:1fr}
      .kpis{grid-template-columns:1fr}
    }
    @media print{.brandbar,nav,.actions,.muted,.hide-on-print{display:none!important};.wrap{gap:6px;padding:0 10px}}
  </style>
</head>
<body>
  <div class="brandbar">
    <div class="row">
      <div class="logo">
        <img src="https://dummyimage.com/140x38/148cd6/ffffff&text=SuperFrio" alt="SuperFrio logo"/>
        <div>
          <h1>SuperFrio – Controle de Carga</h1>
          <p class="tagline">Logística Frigorificada • Carregamento & Descarregamento</p>
        </div>
      </div>
      <nav>
        <button id="tab-novo" class="active"><i class="fa-solid fa-plus"></i> Novo</button>
        <button id="tab-editar"><i class="fa-solid fa-pen-to-square"></i> Editar</button>
        <button id="tab-pesquisar"><i class="fa-solid fa-search"></i> Pesquisar</button>
        <button id="tab-dash"><i class="fa-solid fa-chart-line"></i> Dashboard</button>
      </nav>
    </div>
  </div>

  <div class="wrap">
    <!-- NOVO -->
    <section id="page-novo" class="card">
      <div class="row" style="justify-content:space-between">
        <div class="pill">Documento: <b id="novo-doc"></b> • Status: <b id="novo-status"></b></div>
        <div class="actions">
          <button class="btn" id="novo-salvar"><i class="fa-solid fa-floppy-disk"></i> Salvar</button>
          <button class="btn ghost" id="novo-novo"><i class="fa-solid fa-file-circle-plus"></i> Novo Doc</button>
          <button class="btn ghost" id="novo-imprimir"><i class="fa-solid fa-print"></i> Imprimir / PDF</button>
        </div>
      </div>

      <h3><i class="fa-solid fa-id-badge"></i> Identificação</h3>
      <div class="grid g3">
        <div><label>Nº Documento (auto)</label><input id="novo-numdoc" readonly></div>
        <div><label>Data carregamento</label><input type="date" id="novo-data"/></div>
        <div>
          <label>Status</label>
          <select id="novo-status-select">
            <option>Em trânsito</option>
            <option>Carregando</option>
            <option>Recebido</option>
          </select>
        </div>
        <div><label>Unidade Origem</label><input id="novo-origem" value="RJ"/></div>
        <div><label>Unidade Destino</label><input id="novo-destino"/></div>
        <div><label>Placa</label><input id="novo-placa" placeholder="Ex.: ABC1D23"/></div>
        <div><label>Motorista</label><input id="novo-motorista"/></div>
        <div><label>Conferente (carregamento)</label><input id="novo-conf-origem"/></div>
        <div class="g2" style="grid-column:1/-1"><label>Observações</label><input id="novo-obs"/></div>
      </div>

      <!-- Fotos (NOVO) -->
      <h3 style="margin-top:12px"><i class="fa-solid fa-camera"></i> Fotos</h3>
      <div class="actions">
        <input id="novo-file" type="file" accept="image/*" capture="environment" multiple class="hide"/>
        <button class="btn" id="novo-add-foto"><i class="fa-solid fa-camera-retro"></i> Adicionar foto</button>
        <span class="muted">No celular, abre a câmera.</span>
      </div>
      <div id="novo-fotos" class="photo-grid" style="margin-top:8px"></div>

      <h3 style="margin-top:12px"><i class="fa-solid fa-boxes-stacked"></i> Carregamento</h3>
      <table id="novo-carreg">
        <thead><tr><th>Descrição</th><th>Qtd (pallets)</th><th>Observações</th><th class="hide-on-print"></th></tr></thead>
        <tbody></tbody>
      </table>
      <div class="row" style="justify-content:space-between;margin-top:8px">
        <button class="btn ghost" id="novo-add-item"><i class="fa-solid fa-plus"></i> Adicionar item</button>
        <div class="pill">Total carregado: <b id="novo-total-carreg">0</b></div>
      </div>

      <h3 style="margin-top:12px"><i class="fa-solid fa-truck"></i> Descarregamento</h3>
      <table id="novo-desc">
        <thead><tr><th>Descrição</th><th>Qtd Recebida</th><th>Diferença</th><th>Observações</th></tr></thead>
        <tbody></tbody>
      </table>
      <div class="grid g2" style="margin-top:8px">
        <div><label>Conferente (descarregamento)</label><input id="novo-conf-destino"/></div>
        <div class="row" style="justify-content:flex-end"><div class="pill">Total recebido: <b id="novo-total-receb">0</b> • Diferença total: <b id="novo-total-diff">0</b></div></div>
      </div>
    </section>

    <!-- EDITAR -->
    <section id="page-editar" class="card hide">
      <div class="row">
        <input id="editar-id" placeholder="Digite nº do documento…"/>
        <button class="btn" id="editar-abrir"><i class="fa-solid fa-folder-open"></i> Abrir</button>
        <button class="btn ghost" id="editar-remover"><i class="fa-solid fa-trash"></i> Excluir</button>
      </div>

      <div id="editar-form" class="hide">
        <div class="row" style="justify-content:space-between;margin-top:8px">
          <div class="pill">Documento: <b id="editar-doc"></b> • Status: <b id="editar-status"></b></div>
          <div class="actions">
            <button class="btn" id="editar-salvar"><i class="fa-solid fa-floppy-disk"></i> Salvar</button>
            <button class="btn ghost" id="editar-imprimir"><i class="fa-solid fa-print"></i> Imprimir / PDF</button>
          </div>
        </div>

        <h3><i class="fa-solid fa-id-badge"></i> Identificação</h3>
        <div class="grid g3">
          <div><label>Nº Documento</label><input id="ed-numdoc" readonly></div>
          <div><label>Data carregamento</label><input type="date" id="ed-data"/></div>
          <div>
            <label>Status</label>
            <select id="ed-status">
              <option>Em trânsito</option>
              <option>Carregando</option>
              <option>Recebido</option>
            </select>
          </div>
          <div><label>Unidade Origem</label><input id="ed-origem"/></div>
          <div><label>Unidade Destino</label><input id="ed-destino"/></div>
          <div><label>Placa</label><input id="ed-placa"/></div>
          <div><label>Motorista</label><input id="ed-motorista"/></div>
          <div><label>Conferente (carregamento)</label><input id="ed-conf-origem"/></div>
          <div class="g2" style="grid-column:1/-1"><label>Observações</label><input id="ed-obs"/></div>
        </div>

        <!-- Fotos (EDITAR) -->
        <h3 style="margin-top:12px"><i class="fa-solid fa-camera"></i> Fotos</h3>
        <div class="actions">
          <input id="ed-file" type="file" accept="image/*" capture="environment" multiple class="hide"/>
          <button class="btn" id="ed-add-foto"><i class="fa-solid fa-camera-retro"></i> Adicionar foto</button>
        </div>
        <div id="ed-fotos" class="photo-grid" style="margin-top:8px"></div>

        <h3 style="margin-top:12px"><i class="fa-solid fa-boxes-stacked"></i> Carregamento</h3>
        <table id="ed-carreg">
          <thead><tr><th>Descrição</th><th>Qtd (pallets)</th><th>Observações</th><th class="hide-on-print"></th></tr></thead>
          <tbody></tbody>
        </table>
        <div class="row" style="justify-content:space-between;margin-top:8px">
          <button class="btn ghost" id="ed-add-item"><i class="fa-solid fa-plus"></i> Adicionar item</button>
          <div class="pill">Total carregado: <b id="ed-total-carreg">0</b></div>
        </div>

        <h3 style="margin-top:12px"><i class="fa-solid fa-truck"></i> Descarregamento</h3>
        <table id="ed-desc">
          <thead><tr><th>Descrição</th><th>Qtd Recebida</th><th>Diferença</th><th>Observações</th></tr></thead>
          <tbody></tbody>
        </table>
        <div class="grid g2" style="margin-top:8px">
          <div><label>Conferente (descarregamento)</label><input id="ed-conf-destino"/></div>
          <div class="row" style="justify-content:flex-end"><div class="pill">Total recebido: <b id="ed-total-receb">0</b> • Diferença total: <b id="ed-total-diff">0</b></div></div>
        </div>
      </div>
    </section>

    <!-- PESQUISAR -->
    <section id="page-pesquisar" class="card hide">
      <div class="grid g3">
        <div><label>Nº Documento</label><input id="q-doc"/></div>
        <div><label>Placa</label><input id="q-placa"/></div>
        <div><label>Motorista</label><input id="q-motorista"/></div>
      </div>
      <div class="actions" style="margin-top:8px">
        <button class="btn" id="q-buscar"><i class="fa-solid fa-magnifying-glass"></i> Pesquisar</button>
        <button class="btn ghost" id="q-limpar"><i class="fa-solid fa-broom"></i> Limpar</button>
      </div>
      <div style="margin-top:10px">
        <table id="q-table">
          <thead><tr><th>Documento</th><th>Data</th><th>Placa</th><th>Motorista</th><th>Status</th><th>Ações</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- DASHBOARD -->
    <section id="page-dash" class="card hide">
      <div class="row" style="justify-content:space-between">
        <h3 style="margin:0"><i class="fa-solid fa-chart-pie"></i> Dashboard</h3>
        <div class="row">
          <div>
            <label>De</label>
            <input type="date" id="dash-de">
          </div>
          <div>
            <label>Até</label>
            <input type="date" id="dash-ate">
          </div>
          <button class="btn" id="dash-atualizar" style="align-self:flex-end"><i class="fa-solid fa-arrows-rotate"></i> Atualizar</button>
        </div>
      </div>

      <div class="kpis" style="margin-top:10px">
        <div class="kpi kpi--blue"><div class="title">Paletes enviados</div><div class="value" id="kpi-enviados">0</div></div>
        <div class="kpi kpi--green"><div class="title">Paletes recebidos</div><div class="value" id="kpi-recebidos">0</div></div>
        <div class="kpi kpi--red"><div class="title">Quebra</div><div class="value" id="kpi-quebra">0</div></div>
      </div>

      <div class="card" style="margin-top:10px"><canvas id="dash-chart" height="120"></canvas></div>

      <div class="card" style="margin-top:10px">
        <h4 style="margin:0 0 8px 0"><i class="fa-solid fa-clipboard-list"></i> Detalhes por documento</h4>
        <div class="table-wrap">
          <table id="dash-table">
            <thead>
              <tr>
                <th>Data</th><th>Placa</th><th>Motorista</th>
                <th>Paletes enviados</th><th>Paletes recebidos</th>
                <th>Conferente 1</th><th>Conferente 2</th><th>Status</th>
              </tr>
            </thead><tbody></tbody>
          </table>
        </div>
      </div>
    </section>
  </div>

  <script>
    const $ = (id)=>document.getElementById(id);

    // Tabs
    const tabs={novo:{btn:$("tab-novo"),page:$("page-novo")},
                editar:{btn:$("tab-editar"),page:$("page-editar")},
                pesq:{btn:$("page-pesquisar")?$("tab-pesquisar"):null,page:$("page-pesquisar")},
                dash:{btn:$("tab-dash"),page:$("page-dash")}};
    function activate(t){
      Object.values(tabs).forEach(x=>{ if(!x) return; x.btn.classList.remove('active');x.page.classList.add('hide');});
      t.btn.classList.add('active'); t.page.classList.remove('hide');
    }
    Object.values(tabs).forEach(t=> t && t.btn.addEventListener('click', async ()=>{
      activate(t);
      if(t===tabs.novo) resetNovoForm();
      if(t===tabs.dash) await loadDashboard();
    }));

    // Util
    function genDocId(date = new Date()){
      const y=date.getFullYear(), m=date.getMonth()+1, d=date.getDate();
      const L='ABCDEFGHIJKLMNOPQRSTUVWXYZ';
      let a=L[Math.floor(Math.random()*26)], b=L[Math.floor(Math.random()*26)];
      while(a===b) b=L[Math.floor(Math.random()*26)];
      return `${y}${m}${d}${a}${b}`;
    }
    function ts(){ return new Date().toISOString().replace(/[:.]/g,'-'); }

    // Estado "novo"
    function newDocData(){
      return {id:genDocId(), status:'Em trânsito', data:new Date().toISOString().slice(0,10),
        origem:'RJ', destino:'', placa:'', motorista:'', confOrigem:'', confDestino:'', obs:'', itens:[], photos:[]};
    }
    let novo = newDocData();
    function resetNovoForm(){ novo=newDocData(); renderNovo(); ensureDefaultsNovo(); }

    // ---- Supabase CRUD ----
    async function saveDoc(doc){
      const row = { id:doc.id, data:doc.data||null, placa:doc.placa||null, motorista:doc.motorista||null, status:doc.status||null, payload:doc };
      const { error } = await supa.from('docs').upsert(row);
      if(error){ console.error(error); alert('Erro ao salvar: '+error.message); }
      else { alert('Salvo! Nº '+doc.id); }
    }
    async function getDoc(id){
      const { data, error } = await supa.from('docs').select('payload').eq('id', id).maybeSingle();
      if(error){ console.error(error); alert('Erro ao buscar: '+error.message); return null; }
      return data ? data.payload : null;
    }
    async function delDoc(id){
      const { error } = await supa.from('docs').delete().eq('id', id);
      if(error){ console.error(error); alert('Erro ao excluir: '+error.message); }
      else { alert('Excluído.'); }
    }
    async function allDocs(filters={}){
      let q=supa.from('docs').select('id,data,placa,motorista,status,payload').order('data',{ascending:false});
      if(filters.id) q=q.ilike('id', `%${filters.id}%`);
      if(filters.placa) q=q.ilike('placa', `%${filters.placa}%`);
      if(filters.motorista) q=q.ilike('motorista', `%${filters.motorista}%`);
      const { data, error } = await q;
      if(error){ console.error(error); alert('Erro ao listar: '+error.message); return []; }
      return data;
    }

    // ---- Upload/remoção de fotos (Storage) ----
    const BUCKET = 'fotos'; // bucket público

    function blobFromCanvas(img, max=1280, quality=0.85){
      const canvas = document.createElement('canvas');
      const ratio = Math.min(max / img.width, max / img.height, 1);
      canvas.width  = Math.round(img.width * ratio);
      canvas.height = Math.round(img.height * ratio);
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

      return new Promise((resolve, reject) => {
        canvas.toBlob((b) => {
          if (b) return resolve(b);
          try { // fallback Safari/iOS
            const dataUrl = canvas.toDataURL('image/jpeg', quality);
            const byteString = atob(dataUrl.split(',')[1]);
            const mimeString = dataUrl.split(',')[0].split(':')[1].split(';')[0];
            const ab = new ArrayBuffer(byteString.length);
            const ia = new Uint8Array(ab);
            for (let i=0; i<byteString.length; i++) ia[i] = byteString.charCodeAt(i);
            resolve(new Blob([ab], { type: mimeString }));
          } catch (e) { reject(e); }
        }, 'image/jpeg', quality);
      });
    }
    async function compressFile(file){
      const url = URL.createObjectURL(file);
      const img = new Image();
      img.crossOrigin = 'anonymous';
      await new Promise(ok => { img.onload = ok; img.src = url; });
      const blob = await blobFromCanvas(img, 1280, 0.85);
      URL.revokeObjectURL(url);
      return blob;
    }

    async function uploadPhoto(docId, file){
      try {
        const blob = await compressFile(file);
        const path = `${docId}/${ts()}.jpg`;
        const { error } = await supa
          .storage
          .from(BUCKET)
          .upload(path, blob, { contentType: 'image/jpeg', upsert: false });

        if (error) throw error;

        const { data } = supa.storage.from(BUCKET).getPublicUrl(path);
        return { url: data.publicUrl, path };
      } catch (err) {
        console.error('uploadPhoto error:', err);
        alert('Falha ao enviar foto: ' + (err?.message || err));
        throw err;
      }
    }
    async function deletePhoto(path){
      try{
        const { error } = await supa.storage.from(BUCKET).remove([path]);
        if(error) throw error;
      }catch(err){
        console.error('deletePhoto error:', err);
        alert('Falha ao excluir foto: ' + (err?.message || err));
      }
    }

    // NOVO: render / handlers
    function renderNovo(){
      $('novo-doc').textContent=novo.id; $('novo-status').textContent=novo.status;
      $('novo-numdoc').value=novo.id; $('novo-data').value=novo.data||'';
      $('novo-status-select').value=novo.status||'Em trânsito';
      $('novo-origem').value=novo.origem||''; $('novo-destino').value=novo.destino||'';
      $('novo-placa').value=novo.placa||''; $('novo-motorista').value=novo.motorista||'';
      $('novo-conf-origem').value=novo.confOrigem||''; $('novo-conf-destino').value=novo.confDestino||''; $('novo-obs').value=novo.obs||'';

      // fotos
      const wrap=$('novo-fotos'); wrap.innerHTML='';
      (novo.photos||[]).forEach((ph,i)=>{
        const el=document.createElement('div');
        el.className='thumb';
        el.innerHTML=`<img src="${ph.url}" alt="foto"><button data-i="${i}">Excluir</button><a href="${ph.url}" target="_blank">abrir</a>`;
        wrap.appendChild(el);
      });
      wrap.querySelectorAll('button[data-i]').forEach(b=>{
        b.addEventListener('click', async ()=>{
          const i=Number(b.dataset.i); const ph=novo.photos[i];
          if(confirm('Excluir esta foto?')){ await deletePhoto(ph.path); novo.photos.splice(i,1); renderNovo(); }
        });
      });

      // itens
      const tbC=document.querySelector('#novo-carreg tbody'), tbD=document.querySelector('#novo-desc tbody'); tbC.innerHTML=''; tbD.innerHTML='';
      novo.itens.forEach(it=>{
        tbC.insertAdjacentHTML('beforeend',
        `<tr data-row="${it.id}">
          <td><input id="n-desc-${it.id}" value="${it.desc||''}"></td>
          <td><input id="n-qtd-${it.id}" type="number" min="0" value="${it.qtd!==''?it.qtd:''}"></td>
          <td><input id="n-obs-${it.id}" value="${it.obs||''}"></td>
          <td class="hide-on-print"><button class="btn danger" data-rm="${it.id}"><i class="fa-solid fa-trash"></i> Remover</button></td>
        </tr>`);
        const diff=(Number(it.recebida||0)-Number(it.qtd||0));
        tbD.insertAdjacentHTML('beforeend',
        `<tr data-rowd="${it.id}">
          <td><span id="n-desc-view-${it.id}">${it.desc||''}</span></td>
          <td><input id="n-rec-${it.id}" type="number" min="0" value="${it.recebida!==''?it.recebida:''}"></td>
          <td><span id="n-diff-${it.id}">${diff}</span></td>
          <!-- Campo de observações do descarregamento usa obsd se existir, senão obs -->
          <td><input id="n-obsd-${it.id}" value="${typeof it.obsd !== 'undefined' ? it.obsd : (it.obs||'')}"></td>
        </tr>`);
        hookNovoRow(it.id);
      });
      updateNovoTotals();
    }

    $('novo-add-foto').addEventListener('click', ()=> $('novo-file').click());
    $('novo-file').addEventListener('change', async (e)=>{
      if(!e.target.files?.length) return;
      for(const f of e.target.files){
        try {
          const up = await uploadPhoto(novo.id, f);
          novo.photos.push(up);
        } catch (err) {
          console.warn('Falha ao enviar uma das fotos:', err);
        }
      }
      e.target.value = '';
      renderNovo();
    });

    function hookNovoRow(id){
      const desc=$('n-desc-'+id), qtd=$('n-qtd-'+id), obs=$('n-obs-'+id),
            rec=$('n-rec-'+id), obsd=$('n-obsd-'+id),
            viewDesc=$('n-desc-view-'+id), diffEl=$('n-diff-'+id);
      function recalc(){ const it=novo.itens.find(x=>x.id===id); const diff=(Number(it.recebida||0)-Number(it.qtd||0)); diffEl.textContent=diff; viewDesc.textContent=it.desc||''; updateNovoTotals(); }
      desc.addEventListener('input', e=>{ const it=novo.itens.find(x=>x.id===id); it.desc=e.target.value; viewDesc.textContent=it.desc; });
      qtd.addEventListener('input', e=>{ const it=novo.itens.find(x=>x.id===id); it.qtd=e.target.value===''? '' : Number(e.target.value); recalc(); });
      // Campo observações do carregamento: atualiza apenas it.obs
      obs.addEventListener('input', e=>{
        const it=novo.itens.find(x=>x.id===id);
        it.obs = e.target.value;
      });
      rec.addEventListener('input', e=>{ const it=novo.itens.find(x=>x.id===id); it.recebida=e.target.value===''? '' : Number(e.target.value); recalc(); });
      // Campo observações do descarregamento: atualiza apenas it.obsd
      obsd.addEventListener('input', e=>{
        const it=novo.itens.find(x=>x.id===id);
        it.obsd = e.target.value;
      });
      document.querySelector(`[data-rm="${id}"]`)?.addEventListener('click', ()=>{ novo.itens=novo.itens.filter(x=>x.id!==id); renderNovo(); });
    }
    function updateNovoTotals(){
      const tc=novo.itens.reduce((a,b)=>a+(Number(b.qtd)||0),0);
      const tr=novo.itens.reduce((a,b)=>a+(Number(b.recebida)||0),0);
      $('novo-total-carreg').textContent=tc; $('novo-total-receb').textContent=tr; $('novo-total-diff').textContent=tr-tc;
    }
    $('novo-add-item').addEventListener('click', ()=>{
      const id=genDocId();
      // Novo item com campos separados para observações de carregamento (obs) e descarregamento (obsd)
      novo.itens.push({id,desc:'',qtd:'',obs:'',obsd:'',recebida:''});
      renderNovo();
    });

    ['novo-data','novo-origem','novo-destino','novo-placa','novo-motorista','novo-conf-origem','novo-conf-destino','novo-obs'].forEach(id=>{
      $(id).addEventListener('input', e=>{
        const v=e.target.value; if(id==='novo-data') novo.data=v;
        else if(id==='novo-origem') novo.origem=v;
        else if(id==='novo-destino') novo.destino=v;
        else if(id==='novo-placa') novo.placa=v;
        else if(id==='novo-motorista') novo.motorista=v;
        else if(id==='novo-conf-origem') novo.confOrigem=v;
        else if(id==='novo-conf-destino') novo.confDestino=v;
        else if(id==='novo-obs') novo.obs=v;
      });
    });
    $('novo-status-select').addEventListener('change', e=>{ novo.status=e.target.value; $('novo-status').textContent=novo.status; });
    $('novo-salvar').addEventListener('click', async ()=>{ await saveDoc(novo); });
    $('novo-novo').addEventListener('click', resetNovoForm);
    $('novo-imprimir').addEventListener('click', ()=>window.print());

    // EDITAR
    let editing=null;
    $('editar-abrir').addEventListener('click', async ()=>{
      const id=$('editar-id').value.trim();
      const doc=await getDoc(id);
      if(!doc){alert('Documento não encontrado.'); return;}
      editing=doc; $('editar-form').classList.remove('hide'); renderEditar();
    });
    $('editar-remover').addEventListener('click', async ()=>{
      const id=$('editar-id').value.trim(); if(!id) return;
      if(confirm('Excluir documento '+id+'?')){ await delDoc(id); $('editar-form').classList.add('hide'); }
    });

    function renderEditar(){
      $('editar-doc').textContent=editing.id; $('editar-status').textContent=editing.status;
      $('ed-numdoc').value=editing.id; $('ed-data').value=editing.data||'';
      $('ed-status').value=editing.status||'Em trânsito';
      $('ed-origem').value=editing.origem||''; $('ed-destino').value=editing.destino||''; $('ed-placa').value=editing.placa||''; $('ed-motorista').value=editing.motorista||'';
      $('ed-conf-origem').value=editing.confOrigem||''; $('ed-conf-destino').value=editing.confDestino||''; $('ed-obs').value=editing.obs||'';

      // fotos
      const wrap=$('ed-fotos'); wrap.innerHTML='';
      (editing.photos||[]).forEach((ph,i)=>{
        const el=document.createElement('div');
        el.className='thumb';
        el.innerHTML=`<img src="${ph.url}" alt="foto"><button data-i="${i}">Excluir</button><a href="${ph.url}" target="_blank">abrir</a>`;
        wrap.appendChild(el);
      });
      wrap.querySelectorAll('button[data-i]').forEach(b=>{
        b.addEventListener('click', async ()=>{
          const i=Number(b.dataset.i); const ph=editing.photos[i];
          if(confirm('Excluir esta foto?')){ await deletePhoto(ph.path); editing.photos.splice(i,1); renderEditar(); }
        });
      });

      // itens
      const tbC=document.querySelector('#ed-carreg tbody'), tbD=document.querySelector('#ed-desc tbody'); tbC.innerHTML=''; tbD.innerHTML='';
      (editing.itens||[]).forEach(it=>{
        tbC.insertAdjacentHTML('beforeend',
        `<tr data-row="${it.id}">
          <td><input id="e-desc-${it.id}" value="${it.desc||''}"></td>
          <td><input id="e-qtd-${it.id}" type="number" min="0" value="${it.qtd!==''?it.qtd:''}"></td>
          <td><input id="e-obs-${it.id}" value="${it.obs||''}"></td>
          <td class="hide-on-print"><button class="btn danger" data-rme="${it.id}"><i class="fa-solid fa-trash"></i> Remover</button></td>
        </tr>`);
        const diff=(Number(it.recebida||0)-Number(it.qtd||0));
        tbD.insertAdjacentHTML('beforeend',
        `<tr data-rowd="${it.id}">
          <td><span id="e-desc-view-${it.id}">${it.desc||''}</span></td>
          <td><input id="e-rec-${it.id}" type="number" min="0" value="${it.recebida!==''?it.recebida:''}"></td>
          <td><span id="e-diff-${it.id}">${diff}</span></td>
          <td><input id="e-obsd-${it.id}" value="${typeof it.obsd !== 'undefined' ? it.obsd : (it.obs||'')}"></td>
        </tr>`);
        hookEditarRow(it.id);
      });
      updateEditarTotals();
    }

    $('ed-add-foto').addEventListener('click', ()=> $('ed-file').click());
    $('ed-file').addEventListener('change', async (e)=>{
      if(!editing || !e.target.files?.length) return;
      for(const f of e.target.files){
        try {
          const up = await uploadPhoto(editing.id, f);
          editing.photos = editing.photos || [];
          editing.photos.push(up);
        } catch (err) {
          console.warn('Falha ao enviar uma das fotos:', err);
        }
      }
      e.target.value = '';
      renderEditar();
    });

    function hookEditarRow(id){
      const desc=$('e-desc-'+id), qtd=$('e-qtd-'+id), obs=$('e-obs-'+id),
            rec=$('e-rec-'+id), obsd=$('e-obsd-'+id),
            viewDesc=$('e-desc-view-'+id), diffEl=$('e-diff-'+id);
      function recalc(){ const it=editing.itens.find(x=>x.id===id); const diff=(Number(it.recebida||0)-Number(it.qtd||0)); diffEl.textContent=diff; viewDesc.textContent=it.desc||''; updateEditarTotals(); }
      desc.addEventListener('input', e=>{ const it=editing.itens.find(x=>x.id===id); it.desc=e.target.value; viewDesc.textContent=it.desc; });
      qtd.addEventListener('input', e=>{ const it=editing.itens.find(x=>x.id===id); it.qtd=e.target.value===''? '' : Number(e.target.value); recalc(); });
      // Observações do carregamento: atualiza apenas it.obs
      obs.addEventListener('input', e=>{
        const it=editing.itens.find(x=>x.id===id);
        it.obs = e.target.value;
      });
      rec.addEventListener('input', e=>{ const it=editing.itens.find(x=>x.id===id); it.recebida=e.target.value===''? '' : Number(e.target.value); recalc(); });
      // Observações do descarregamento: atualiza apenas it.obsd
      obsd.addEventListener('input', e=>{
        const it=editing.itens.find(x=>x.id===id);
        it.obsd = e.target.value;
      });
      document.querySelector(`[data-rme="${id}"]`)?.addEventListener('click', ()=>{ editing.itens=editing.itens.filter(x=>x.id!==id); renderEditar(); });
    }
    function updateEditarTotals(){
      const tc=(editing.itens||[]).reduce((a,b)=>a+(Number(b.qtd)||0),0);
      const tr=(editing.itens||[]).reduce((a,b)=>a+(Number(b.recebida)||0),0);
      $('ed-total-carreg').textContent=tc; $('ed-total-receb').textContent=tr; $('ed-total-diff').textContent=tr-tc;
    }
    $('editar-salvar').addEventListener('click', async ()=>{ if(!editing) return; await saveDoc(editing); alert('Atualizado!'); });
    $('editar-imprimir').addEventListener('click', ()=>window.print());
    ['ed-data','ed-origem','ed-destino','ed-placa','ed-motorista','ed-conf-origem','ed-conf-destino','ed-obs'].forEach(id=>{
      $(id).addEventListener('input', e=>{
        if(!editing) return; const v=e.target.value;
        if(id==='ed-data') editing.data=v; else if(id==='ed-origem') editing.origem=v;
        else if(id==='ed-destino') editing.destino=v; else if(id==='ed-placa') editing.placa=v;
        else if(id==='ed-motorista') editing.motorista=v; else if(id==='ed-conf-origem') editing.confOrigem=v;
        else if(id==='ed-conf-destino') editing.confDestino=v; else if(id==='ed-obs') editing.obs=v;
      });
    });
    $('ed-status').addEventListener('change', e=>{ if(!editing) return; editing.status=e.target.value; $('editar-status').textContent=editing.status; });

    // PESQUISAR
    $('q-buscar').addEventListener('click', async ()=>{
      const rows = await allDocs({
        id: $('q-doc').value.trim().toUpperCase(),
        placa: $('q-placa').value.trim().toUpperCase(),
        motorista: $('q-motorista').value.trim().toUpperCase()
      });
      renderSearch(rows);
    });
    $('q-limpar').addEventListener('click', ()=>{ $('q-doc').value=''; $('q-placa').value=''; $('q-motorista').value=''; renderSearch([]); });
    function renderSearch(rows){
      const tb=document.querySelector('#q-table tbody'); tb.innerHTML='';
      rows.forEach(d=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${d.id}</td><td>${d.data||''}</td><td>${d.placa||''}</td><td>${d.motorista||''}</td><td>${d.status||''}</td>
                      <td><button class='btn ghost' data-open='${d.id}'><i class="fa-solid fa-pen-to-square"></i> Editar</button></td>`;
        tb.appendChild(tr);
      });
      tb.querySelectorAll('button[data-open]').forEach(b=> b.addEventListener('click', async (e)=>{
        const id=e.target.getAttribute('data-open'); tabs.editar.btn.click(); $('editar-id').value=id;
        const doc=await getDoc(id); if(!doc){alert('Documento não encontrado.'); return;}
        editing=doc; $('editar-form').classList.remove('hide'); renderEditar();
      }));
    }

    // DASHBOARD
    let dashChart=null;
    function sumFromDocs(docs){
      let enviados=0, recebidos=0, quebra=0; const porDia={};
      for(const d of docs){
        const dataDia=d.data||'SemData'; if(!porDia[dataDia]) porDia[dataDia]={env:0,rec:0,qbr:0};
        const itens=(d.payload?.itens)||[];
        for(const it of itens){
          const q=Number(it.qtd||0), r=Number(it.recebida||0), qbr=Math.max(0,q-r);
          enviados+=q; recebidos+=r; quebra+=qbr;
          porDia[dataDia].env+=q; porDia[dataDia].rec+=r; porDia[dataDia].qbr+=qbr;
        }
      } return {enviados,recebidos,quebra,porDia};
    }
    function totalLinha(payload){ let env=0, rec=0; (payload?.itens||[]).forEach(it=>{env+=Number(it.qtd||0); rec+=Number(it.recebida||0);}); return {env,rec}; }

    async function loadDashboard(){
      const de=$('dash-de').value, ate=$('dash-ate').value;
      let q=supa.from('docs').select('data,placa,motorista,status,payload').order('data',{ascending:true});
      if(de) q=q.gte('data',de); if(ate) q=q.lte('data',ate);
      const { data, error } = await q;
      if(error){ console.error(error); alert('Erro ao carregar dashboard: '+error.message); return; }

      const agg=sumFromDocs(data);
      $('kpi-enviados').textContent=agg.enviados; $('kpi-recebidos').textContent=agg.recebidos; $('kpi-quebra').textContent=agg.quebra;

      const dias=Object.keys(agg.porDia).sort();
      const serieEnv=dias.map(d=>agg.porDia[d].env), serieRec=dias.map(d=>agg.porDia[d].rec), serieQbr=dias.map(d=>agg.porDia[d].qbr);
      const ctx=document.getElementById('dash-chart').getContext('2d'); if(dashChart) dashChart.destroy();

      /* ====== GRÁFICO COM LINHAS SUAVES E MONOTÔNICAS ====== */
      dashChart=new Chart(ctx,{
        type:'line',
        data:{
          labels:dias,
          datasets:[
            { label:'Enviados', data:serieEnv, borderColor:'#148CD6', backgroundColor:'rgba(20,140,214,0.10)', tension:0.4, cubicInterpolationMode:'monotone' },
            { label:'Recebidos', data:serieRec, borderColor:'#16a34a', backgroundColor:'rgba(22,163,74,0.10)',  tension:0.4, cubicInterpolationMode:'monotone' },
            { label:'Quebra',    data:serieQbr, borderColor:'#dc2626', backgroundColor:'rgba(220,38,38,0.10)',  tension:0.4, cubicInterpolationMode:'monotone' }
          ]
        },
        options:{
          responsive:true,
          plugins:{ legend:{position:'top'} },
          interaction:{mode:'index',intersect:false},
          scales:{ y:{ beginAtZero:true } }
        }
      });
      /* ===================================================== */

      const tb=document.querySelector('#dash-table tbody'); tb.innerHTML='';
      for(const d of data){
        const { env, rec }=totalLinha(d.payload||{});
        const placa=d.placa ?? d.payload?.placa ?? ''; const mot=d.motorista ?? d.payload?.motorista ?? '';
        const c1=d.payload?.confOrigem ?? ''; const c2=d.payload?.confDestino ?? ''; const st=d.status ?? d.payload?.status ?? '';
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${d.data||''}</td><td>${placa}</td><td>${mot}</td><td>${env}</td><td>${rec}</td><td>${c1}</td><td>${c2}</td><td>${st}</td>`;
        tb.appendChild(tr);
      }
    }
    $('dash-atualizar')?.addEventListener('click', loadDashboard);

    // Init
    function ensureDefaultsNovo(){
      if(novo.itens.length === 0){
        const id = genDocId();
        // Cria item padrão com campos separados para observações de carregamento (obs) e descarregamento (obsd)
        novo.itens.push({ id, desc:'', qtd:'', obs:'', obsd:'', recebida:'' });
        renderNovo();
      }
    }
    resetNovoForm();
  </script>
</body>
</html>
